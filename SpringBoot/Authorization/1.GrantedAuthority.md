## Authorization
### `GrantedAuthority`
- [01/30 commit ì°¸ê³ ](https://github.com/Jang2723/likelion-auth/commits/main/)
ì‚¬ìš©ìê°€ ëˆ„êµ¬ì¸ì§€ ì¸ì¦ë˜ì—ˆë‹¤ë©´, ì‚¬ìš©ìì— ë”°ë¼ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ì„œë¹„ìŠ¤ì˜ ë²”ìœ„ë¥¼ ë‚˜ëˆŒ ìˆ˜ ìˆìŒ   
`UserDetails`ì´ ë‚˜íƒ€ë‚´ëŠ” ì‚¬ìš©ìê°€ ê°€ì§„ ê¶Œí•œì„ ë¬˜ì‚¬í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ì˜ ë©”ì„œë“œ ì¤‘ í•˜ë‚˜ì¸ `getAuthorities` ì‚¬ìš©
```java
// UserDetailsì˜ ë‚´ë¶€ ëª¨ìŠµ, ë‚˜ëŠ” ë§Œë“¤ì§€ ì•ŠìŒ!
public interface UserDetails extends Serializable {
    // ...
    /**
     * Returns the authorities granted to the user. Cannot return <code>null</code>.
     * @return the authorities, sorted by natural key (never <code>null</code>)
     */
    Collection<? extends GrantedAuthority> getAuthorities();

    // ...
}
```
- ì´ ë©”ì„œë“œê°€ ëŒë ¤ì¤˜ì•¼ í•˜ëŠ” `GrantedAuthority`ëŠ” ì´ `UserDetails`ê°€ ë‚˜íƒ€ë‚´ëŠ” ì‚¬ìš©ìê°€ ê°€ì§„ ê¶ˆí•œì„ ë‚˜íƒ€ë‚´ëŠ” `interface`
- Spring Security ë‚´ë¶€ì—ì„œëŠ” ë³´í†µ ë¬¸ìì—´ í˜•ì‹ìœ¼ë¡œ ê¶Œí•œì„ í‘œí˜„í•˜ëŠ” `SimpleGrantedAuthority` ì‚¬ìš©
- if, ì‚¬ìš©ì ê¶ˆí•œì— ë”°ë¼ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” endpointë¥¼ êµ¬ë¶„í•˜ê³  ì‹¶ë‹¤ë©´, ì‚¬ìš©ìê°€ ì–´ë–¤ ì‘ì—…ì„ í•  ìˆ˜ ìˆëŠ”ì§€ ë¬¸ìì—´ í˜•íƒœë¡œ í‘œí˜„í•  ìˆ˜ ìˆê²Œ ì •ë¦¬í•œ ë’¤, Spring Securityì˜ ê¸°ëŠ¥ì„ ì¼ë¶€ë¶„ ì ìš© ê°€ëŠ¥
---
### ì‚¬ìš©ì ê¶Œí•œ í‘œí˜„(UserEntityì— ê¶Œí•œ ì¶”ê°€)
`UserDetailsService`ë¥¼ í†µí•´ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ê¶Œí•œì„ ì €ì¥í•´ì•¼ í•˜ëŠ”ì§€ êµ¬í˜„í•  ìˆ˜ ìˆë“¯ `UserEntity`ê°ì²´ì— Column í˜•ì‹ìœ¼ë¡œ ë¶€ì—¬ ê°€ëŠ¥
```java
@Getter
@Builder
@Entity
@Table(name = "user_table")
@NoArgsConstructor
@AllArgsConstructor
public class UserEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true)
    private String username;
    private String password;

    private String email;
    private String phone;

    // testë¥¼ ìœ„í•´ì„œ ë¬¸ìì—´ í•˜ë‚˜ì— ','ë¡œ êµ¬ë¶„í•´ ê¶Œí•œì„ ë¬˜ì‚¬
    // ROLE_USER, ROLE_ADMIN, READ_AUTHORITY, WRITE_AUTHORITY
    private String authorities;
}

```
- ì§€ê¸ˆì€ ê°„ë‹¨í•˜ê²Œ ê¸°ëŠ¥í™•ì¸ì„ ìœ„í•´ ë¬¸ìì—´ë¡œ í‘œí˜„í•¨
- ì—¬ëŸ¬ ê¶Œí•œì„ ê°€ì§„ ì‚¬ìš©ìëŠ” `,`ë¡œ êµ¬ë¶„í•´ì„œ ì €ì¥
- `CustomUserDetails`ì—ë„ `private String authorities`ì¶”ê°€
- ì´ë–„, `getAuthorities`ë©”ì„œë“œëŠ” `UserDetails` ì¸í„°í˜ì´ìŠ¤ì— ì´ë¯¸ ì •ì˜ëœ ë©”ì„œë“œì´ê¸° ë•Œë¬¸ì— ê¶Œí•œì„ ë‹´ê³  ìˆëŠ” `authorities`ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒˆë¡œ ìƒì„±í•˜ê³  ë°˜í™˜í•˜ë„ë¡ ë§Œë“¤ì–´ ì£¼ì–´ì•¼ í•¨
- ì•„ë˜ëŠ” ì €ì¥í•œ ê¶Œí•œì„ `,`ì„ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬, ê°ê°ì˜ ê¶ˆí•œì„ `SimpleGrantedAuthority`ë¡œ ë³€í™˜í•˜ì—¬ `List`í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” ì˜ˆì‹œ
```java
public class CustomUserDetails implements UserDetails {
    // ...
    private String authorities;

    public String getRawAuthorities() {
        return this.authorities;
    }
    
    @Override
    // ROLE_USER, ROLE_ADMIN, READ_AUTHORITY, WRITE_AUTHORITY
    public Collection<? extends GrantedAuthority> getAuthorities() {
        List<GrantedAuthority> grantedAuthorities
                = new ArrayList<>();
        String[] rawAuthorities = authorities.split(",");
        for (String rawAuthority : rawAuthorities){
            grantedAuthorities.add(new SimpleGrantedAuthority(rawAuthority));
        }
        //return Set.of();
        //return List.of(new SimpleGrantedAuthority("ROLE_USER"));
        return grantedAuthorities;
    }

}
```
- `JpaUserDetailsService`ì—ì„œ `CustomUserDetails`ë¥¼ ì „ë‹¬í•  ë•Œ ê¶Œí•œì„ í•¨ê»˜ ì „ë‹¬
```java
//JpaUserDetailsService.java
   @Override
    // formLogin ë“± Spring Security ë‚´ë¶€ì—ì„œ
    // ì¸ì¦ì„ ì²˜ë¦¬í• ë•Œ ì‚¬ìš©í•˜ëŠ” ë©”ì„œë“œì´ë‹¤.
    public UserDetails loadUserByUsername(String username)
            throws UsernameNotFoundException {
        Optional<UserEntity> optionalUser
                = userRepository.findByUsername(username);
        if (optionalUser.isEmpty())
            throw new UsernameNotFoundException(username);

        UserEntity userEntity = optionalUser.get();
        return CustomUserDetails.builder()
                .username(userEntity.getUsername())
                .password(userEntity.getPassword())
                .email(userEntity.getEmail())
                .phone(userEntity.getPhone())
                .authorities(userEntity.getAuthorities())
                .build();
    }
```
- ì´ì œ ì‚¬ìš©ì ê³„ì •ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì¶”ê°€í•  ë–„ ê¸°ë³¸ ê¶Œí•œì„ ì¶”ê°€í•´ ì¤„ ìˆ˜ ìˆìŒ
```java
// JpaUserDetailsService.java
@Override
// í¸ì˜ë¥¼ ìœ„í•´ ê°™ì€ ê·œì•½ìœ¼ë¡œ íšŒì›ê°€ì…ì„ í•˜ëŠ” ë©”ì„œë“œ
public void createUser(UserDetails user) {
        if (userExists(user.getUsername())) // ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ ì‚¬ìš©ìê°€ ìˆë‹¤ëŠ” ëœ» -> ì˜¤ë¥˜
             throw new ResponseStatusException(HttpStatus.BAD_REQUEST);

        try{
            CustomUserDetails userDetails =
                    (CustomUserDetails) user;
            UserEntity newUser = UserEntity.builder()
                    .username(userDetails.getUsername())
                    .password(userDetails.getPassword())
                    .email(userDetails.getEmail())
                    .phone(userDetails.getPhone())
                    .authorities(userDetails.getRawAuthorities())
                    .build();
            userRepository.save(newUser);
        }catch (ClassCastException e){
           log.error("Failed Cast to: {}", CustomUserDetails.class);
            throw new ResponseStatusException(HttpStatus.INTERNAL_SERVER_ERROR);
        }
```
---
### Roleê³¼ Authority
Spring SecurityëŠ” ê¶Œí•œì„ ë‘ ì¢…ë¥˜ë¡œ ë¶„ë¥˜
- Role: ì‚¬ìš©ìì˜ ê³„ê¸‰, ì—­í•  ë“±(ex. ì‚¬ìš©ì, ê´€ë¦¬ì ë“±)
- Authority: ì‚¬ìš©ìê°€ íŠ¹ì • ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œ(ex. ê²Œì‹œê¸€ ì‘ì„± ê¶Œí•œ, ëŒ“ê¸€ ì‘ì„± ê¶Œí•œ)
- => ê°œë…ì ìœ¼ë¡œ ë¶„ë¥˜ëœ ê²ƒ, `GrantedAuthority.getAuthority()`ì˜ ê²°ê³¼ê°€ `ROLE_`ë¡œ ì‹œì‘í•˜ë©´ Role, ì•„ë‹ˆë©´ Authorityë¡œ ì·¨ê¸‰
- ì´ì œ ì‚¬ìš©ì ê³„ì •ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì¶”ê°€í•  ë•Œ ê¸°ë³¸ ê¶Œí•œì„ ì¶”ê°€í•´ ì¤„ ìˆ˜ ìˆìŒ
```java
// JpaUserDetailsService.java
createUser(CustomUserDetails.builder()
            .username("user")
            .password(passwordEncoder.encode("password"))
            .email("user1@gamil.com")
            .phone("01012345678")
            .authorities("ROLE_USER,READ_AUTHORITY")
            .build());
```
- `.authorities(userDetails.getRawAuthorities())` , `.authorities("ROLE_USER)` ë‘˜ë‹¤ ê°€ëŠ¥
> ğŸ’¡ ë¯¸ì¸ì¦(ë¡œê·¸ì¸ ì•ˆí•œ) ì‚¬ìš©ìì˜ ê²½ìš° `ROLE_ANONYMOUS` ë¶€ì—¬ë¨
---
### `Authetication`ì— ê¶Œí•œ ë¶€ì—¬
- Spring Securityê°€ ì œê³µí•˜ëŠ” ì¸ì¦ ë°©ì‹(ex. Form Login)ì„ ì‚¬ìš©í•˜ê³  ìˆë‹¤ë©´
  - => `Authentication`ì— ìë™ìœ¼ë¡œ ì‚¬ìš©ìì˜ ê¶Œí•œ ì„¤ì •
  - `UserDetails`ì˜ `getAuthorities()`ì˜ ê²°ê³¼ë¥¼ ë“±ë¡í•˜ê¸° ë–„ë¬¸!


- `Filter`ë¥¼ ì‚¬ìš©í•´ ì§ì ‘ `Authentication`ì„ ì„¤ì •í•´ ì¸ì¦ì„ ì§„í–‰í•˜ê³  ìˆë‹¤ë©´
  - ì§ì ‘ `AuthenticationToken`ì—ë„ ì‚¬ìš©ìì˜ ê¶Œí•œì„ ì„¤ì •í•´ ì£¼ì–´ì•¼ í•¨
```java
UserDetails userDetails = manager.loadUserByUsername(username);
                for (GrantedAuthority authority : userDetails.getAuthorities()){
                        log.info("authorities: {}",authority.getAuthority());
                }
                // ì¸ì¦ ì •ë³´ ìƒì„±
                AbstractAuthenticationToken authenticationToken
                        = new UsernamePasswordAuthenticationToken(
                        userDetails,
                        token,
                        userDetails.getAuthorities()
                );
                // ì¸ì¦ ì •ë³´ ë“±ë¡
                context.setAuthentication(authenticationToken);
                SecurityContextHolder.setContext(context);
                log.info("set security context with jwt");
```
- `UserDetailsService`ì˜ ê²°ê³¼ í™œìš©ë„ ê°€ëŠ¥
