## Repository, Service Test
### `Repository` ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
> ğŸ’¡ [UserRepositoryTests](https://github.com/Jang2723/likelion-testing/blob/main/src/test/java/com/example/contents/UserRepositoryTests.java)
- `UserRepository`ì˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
  - `Entity`ê°€ ì˜ë„í•œëŒ€ë¡œ ì €ì¥ë˜ê±°ë‚˜, ì €ì¥ë˜ì§€ ì•ŠëŠ”ì§€
  - `UserRepository`ì— ì‘ì„±í•œ Query Methodê°€ ì˜ë„í•œëŒ€ë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸


- í…ŒìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ í´ë˜ìŠ¤ ì‘ì„±
```java
// UserRepositoryì˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ í…ŒìŠ¤íŠ¸ë“¤
@DataJpaTest
public class UserRepositoryTests {
    @Autowired
    private UserRepository userRepository;

    // ...
}
```
- `@DataJpaTest` : JPAë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•œ ë¶€ë¶„ë“¤ë§Œ ì‚¬ìš©í•˜ë„ë¡ í•´ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜
- `Autowired` : ì˜ì¡´ì„± ì£¼ì… ì–´ë…¸í…Œì´ì…˜

---
### given - when - then íŒ¨í„´
- í…ŒìŠ¤íŠ¸ë¥¼ ê°€ë…ì„±ì´ ì¢‹ê²Œ ì‘ì„±í•˜ê¸° ìœ„í•œ íŒ¨í„´
- given : í…ŒìŠ¤íŠ¸ê°€ ì§„í–‰ë˜ê¸° ìœ„í•œ ê¸°ë³¸ ì¡°ê±´ì„ ì¤€ë¹„í•˜ëŠ” ë¶€ë¶„
  - ex) `username`ì„ ê°€ì§€ê³  `User`ë¥¼ ì°¾ëŠ” ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸, DBì— `user` ë°ì´í„°ê°€ ì¶”ê°€ë˜ì–´ ìˆì–´ì•¼ í•¨ => ì´ ë¶€ë¶„ì„ ì¤€ë¹„


- when : í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ í•˜ê³ ì‹¶ì€ ê¸°ëŠ¥ì„ ì‹¤í–‰í•˜ëŠ” ë¶€ë¶„, ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ëŠ ë¶€ë¶„


- then : ì‹¤í–‰ëœ í…ŒìŠ¤íŠ¸ì˜ ê²°ê³¼ê°€ ê¸°ëŒ€í•œ ê²ƒê³¼ ë™ì¼í•œì§€ ê²€ì¦í•˜ëŠ” ë¶€ë¶„
---
### ìƒˆë¡œìš´ `User` ìƒì„± í…ŒìŠ¤íŠ¸
- `UserRepository.save()` ë¥¼ ì´ìš©í•´ ìƒˆë¡œìš´ `User` ìƒì„±
  - given : ìƒì„±í•œ `User`ì˜ `username`ì„ ê²°ì •í•˜ê³  í• ë‹¹
  - when : `UserRepository.save()` ì§„í–‰
  - then : `UserRepository.save()` ê²°ê³¼ì˜ `getId()` ëŠ” nullì´ ì•„ë‹ˆê³ , `getUsername()`ì€ ì…ë ¥í•œ ê°’ ê·¸ëŒ€ë¡œì¸ì§€ í™•ì¸

```java
// ì‚¬ìš©ìë¥¼ ì¶”ê°€í•˜ëŠ” í…ŒìŠ¤íŠ¸
    @Test
    @DisplayName("ìƒˆë¡œìš´ User ì¶”ê°€")
    public void testCreateUser() {
        // í…ŒìŠ¤íŠ¸ì˜ ê°€ë…ì„±ì„ ë†’ì´ëŠ” íŒ¨í„´
        // given - í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ê¸° ìœ„í•œ ê¸°ë³¸ ì¡°ê±´ì„ ë§Œë“¤ì–´ ë‘ëŠ” ë¶€ë¶„
        // ë‚´ê°€ ë§Œë“¤ê³ ì í•˜ëŠ” User ì—”í‹°í‹°ê°€ ìˆëŠ” ìƒí™©ì—ì„œ
        String username = "subin";
        User user = new User(username, null, null, null);

        // when  - ì‹¤ì œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ëŠ” ë¶€ë¶„
        // userRepository.save(user)ë¥¼ ì§„í–‰í•œë‹¤.
        User result = userRepository.save(user);

        // then  - ë‚´ê°€ ê¸°ëŒ€í•œëŒ€ë¡œ ë™ì‘í–ˆëŠ”ì§€ ê²€ì¦
        // userRepository.save()ì˜ ê²°ê³¼ì˜ usernameì´ ë³¸ë˜ Userì˜ usernameê³¼ ì¼ì¹˜í–ˆëŠ”ì§€
        assertEquals(username, result.getUsername());
        // userRepository.save()ì˜ ê²°ê³¼ì˜ idê°€ nullì´ ì•„ë‹Œì§€
        assertNotNull(result.getId());
    }
```
- Assertion : í…ŒìŠ¤íŠ¸ ê³¼ì •ì—ì„œ ê¸°ëŒ€í•œ ê²°ê³¼ê°€ ë“œëŸ¬ë‚¬ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ì½”ë“œ
- `assertNotNull` : ì£¼ì–´ì§„ ê°’ì´ `null`ì´ ì•„ë‹Œì§€ ê²€ì¦
- `assertEquals` : ì£¼ì–´ì§„ ë‘ ê°’ì´ ë™ì¼í•œì§€ ê²€ì¦
- `@DisplayName("ìƒˆë¡œìš´ User ì¶”ê°€")` : í‘œì‹œë˜ëŠ” ë°©ì‹ì„ ë°”ê¿€ ìˆ˜ë„ ìˆìŒ

---
### ìƒˆë¡œìš´ `User` ìƒì„± ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸
- `username`ì´ ê°™ì€ `User`ê°€ ì¡´ì¬í•  ê²½ìš° ìƒì„± ë¶ˆê°€ëŠ¥
- given : ë¯¸ë¦¬ `username`ì„ ê°€ì§„ `User` ìƒì„±
- when : ë™ì¼í•œ `username`ì„ ê°€ì§„ `User`ë¥¼ ê°€ì§€ê³  `userRepository.save()` í˜¸ì¶œ
- then : ì˜ˆì™¸ ë°œìƒ

```java
@Test
    @DisplayName("ìƒˆë¡œìš´ User ì¶”ê°€ ì‹¤íŒ¨(ì¤‘ë³µ username)")
    public void testCreateUserFail(){
        // given - ì–´ë–¤ íŠ¹ì • usernameì„ ê°€ì§„ Userê°€ ì´ë¯¸ ì €ì¥ëœ ìƒí™©ì—ì„œ
        String username = "subin";
        User userGiven = new User(username, null, null, null);
        userRepository.save(userGiven);

        // when - ë™ì¼í•œ usernameì„ ê°€ì§„ Userë¥¼ ì €ì¥í•˜ë ¤ê³  í•˜ë©´
        User newUser = new User(username, null, null, null);

        // then - ì‹¤íŒ¨í•œë‹¤.
        assertThrows(Exception.class, () -> userRepository.save(newUser));
    }
```
- `assertThrows` : ì „ë‹¬ë°›ì€ ë©”ì„œë“œë¥¼ ì‹¤í–‰í•˜ë©´ì„œ ê·¸ ê³¼ì •ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí–ˆëŠ”ì§€ ê²€ì¦
---
### `Service` ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
> ğŸ’¡ [UserServiceTests](https://github.com/Jang2723/likelion-testing/blob/main/src/test/java/com/example/contents/UserServiceTests.java)
- `UserService`ì˜ ê²½ìš° `UserRepository`ê°€ ìˆì–´ì•¼ ì •ìƒ ì‘ë™
```java
@Slf4j
@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository repository;

    // ...
}
```
- ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì¸ ë§Œí¼ ì‹¤ì œ Repositoryë¥¼ ê°€ì ¸ì™€ì„œ í…ŒìŠ¤íŠ¸í•˜ì§€ ì•ŠìŒ
- `UserRepository`ì˜ ì—­í• ì„ í•˜ëŠ” ì„ì‹œ ê°ì²´ ìƒì„± => `Mock`(ëª¨ì¡°)ë¼ê³  ë¶€ë¦„
```java
@ExtendWith(MockitoExtension.class)
public class UserServiceTests {
    @Mock
    private UserRepository userRepository;

    @InjectMocks
    private UserService userService;

    // ...
}
```
- `@ExtendWith` : Mock ê¸°ëŠ¥ ì‚¬ìš© (ex. `@Mock`,`@InjectMocks` ë“±)
- `@Mock` : ì´ ê°ì²´ëŠ” ì‹¤ì œê°€ ì•„ë‹Œ Mock ê°ì²´ì„ì„ ë‚˜íƒ€ëƒ„
- `@InjectMocks` : ì´ ê°ì²´ì˜ ì˜ì¡´ì„±ì€ `Mock`ê°ì²´ë¥¼ ì‚¬ìš©í•œë‹¤ëŠ” ì˜ë¯¸
---
### `UserDto`ë¥¼ ë°›ì•„ `User` ìƒì„±
```java
 // UserDtoë¥¼ ì¸ìë¡œ ë°›ì•„ Userë¥¼ ìƒì„±í•˜ê³ 
    // ê·¸ ê²°ê³¼ë¥¼ UserDtoë¡œ ë°˜í™˜
    @Test
    @DisplayName("UserDtoë¡œ ì‚¬ìš©ì ìƒì„±")
    public void testCreateUser() {
        // given
        // 1. userRepositoryê°€ íŠ¹ì • Useë¥¼ ì „ë‹¬ë°›ì„ ê²ƒì„ ê°€ì •í•œë‹¤.
        String username = "subin";
        // userRepositoryê°€ ì…ë ¥ë°›ì„ user
        User userIn = new User(username, null, null, null);
        // 2. userRepositoryê°€ ë°˜í™˜í•  user
        User userOut = new User(username, null, null, null);
//        userOut.setId(1L); // ì ê¹ Userì˜ idì— @Setter ë¶™ì„

        // 3. userRepository.save(userIn)ì˜ ê²°ê³¼ë¥¼ userOutìœ¼ë¡œ ì„¤ì •
        when(userRepository.save(userIn))
                .thenReturn(userOut);
        when(userRepository.existsByUsername(username))
                .thenReturn(false);

        // when - userDtoë¥¼ ì „ë‹¬í•œë‹¤.
        UserDto userDto = new UserDto(
                null,
                username,
                null,
                null,
                null,
                null
        );
        UserDto result = userService.create(userDto);

        // then - ëŒì•„ì˜¨ resultë¥¼ ê²€ì‚¬í•œë‹¤.
        assertEquals(username, result.getUsername());
    }
```
- `userIn` ì€ `UserDto`ì—ì„œ ë³€í™˜ë  `User`
- `userOut`ì€ `userIn`ì„ ì¸ìë¡œ ë°›ì€ `userRepository.save()`ë©”ì„œë“œê°€ ë°˜í™˜í•  `User`
- `userRepository.save()` ì‹¤í–‰í–ˆì„ ë•Œ ì‹¤ì œë¡œ `userOut`ì´ ë°˜í™˜ë˜ë„ë¡ ì •ì˜í•œëŠ ë¶€ë¶„ì´ `when`

> ğŸ’¡ ê·¸ ì™¸ í…ŒìŠ¤íŠ¸ github ì°¸ê³  : `username`ìœ¼ë¡œ `UserDto` ë°˜í™˜, `User`ì— ì´ë¯¸ì§€ ì¶”ê°€, `UserDto`ë¥¼ ì´ìš©í•´ `User`ìˆ˜ì • 
