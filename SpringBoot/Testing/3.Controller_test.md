## Controller Test
> ğŸ’¡ [UserControllerTests](https://github.com/Jang2723/likelion-testing/blob/main/src/test/java/com/example/contents/UserControllerTests.java)

- `Controller`ëŠ” ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë°ì´í„°ê°€ HTTP ìš”ì²­ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ê²ƒì„ ê°€ì •
- ì´ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê°ì²´ê°€ `MockMvc`
```java
@ExtendWith(MockitoExtension.class)
public class UserControllerTests {
    @Mock
    private UserService userService;

    @InjectMocks
    private UserController userController;

    private MockMvc mockMvc;

    // ì´ í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ì˜ ê°œë°œ í´ë˜ìŠ¤ ì „ì— ì‹¤í–‰í•  ì½”ë“œ
    @BeforeEach
    public void beforeEach() {
        mockMvc = MockMvcBuilders
                .standaloneSetup(userController)
                .build();
    }
}
```
- `MockMvc` ëŠ” `MockMvcBuilder.standalonSetup(userController).build()`ë¥¼ ì‚¬ìš©í•˜ë©´ 
  - `UserController`ë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•œ ì—”ë“œí¬ì¸íŠ¸ë§Œ ì„¤ì •í•œ ì„œë²„ë¥¼ `Mock`í•¨
- ì´ë¥¼ ì‹¤í–‰í•˜ëŠ” `@BeforeEach` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ ë©”ì„œë“œëŠ” ê° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì´ì „ì— `mockMvc`ê°€ ì´ˆê¸°í™” 
- `UserService`ì˜ `@Mock`ê³¼ `UserController`ì˜ `@InjectMocks`ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ë™ì‘
---
### JsonUtil
- ìš”ì²­ì„ ë³´ë‚¼ë•Œ JSON ë°ì´í„°ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ ê°„ë‹¨í•œ ê°ì²´ => JSON ë¬¸ìì—´ ë³€í™˜ê¸° ìƒì„±
```java

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.io.IOException;

// ê°ì²´ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•´ì£¼ëŠ” ë„êµ¬
public class JsonUtil {
    static byte[] toJson(Object object) throws IOException {
        ObjectMapper mapper = new ObjectMapper();
        mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);
        return mapper.writeValueAsBytes(object);
    }
}
```
- `ObjectMapper`ëŠ” Jackson ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” ê°ì²´, ì´ë¥¼ ì‚¬ìš©í•˜ì—¬ Javaê°ì²´ë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•˜ê±°ë‚˜ JSONì„ Javaê°ì²´ë¡œ ë³€í™˜
- `mapper.setSerializationInclusion(JsonInclude.Include.NON_NULL);` : `mapper`ì˜ serializationì„ êµ¬ì„±
  - ì´ ì½”ë“œëŠ” `maaper`ê°€ NULL ê°’ì„ ê°–ëŠ” ì†ì„±ì„ JSONìœ¼ë¡œ ì§ë ¬í™”í•˜ì§€ ì•Šë„ë¡ ì„¤ì •
  - ì¦‰, JSONì— NULL ê°’ì„ ê°–ëŠ” ì†ì„±ì´ í¬í•¨ë˜ì§€ ì•ŠìŒ
- `return mapper.writeValueAsBytes(object);` `mapper`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì–´ì§„ ê°ì²´ë¥¼ JSONìœ¼ë¡œ ì§ë ¬í™” í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ byte ë°°ì—´ë¡œ ë°˜í™˜
----
### `UserDto` ìš”ì²­í•  ê²½ìš° `UserDto` ìš”ì²­ ë°›ê¸°
```java
@Test
    @DisplayName("UserDtoë¥¼ í‘œí–”í•œ JSON ìš”ì²­ì„ ë³´ë‚´ë©´ UserDtoë¥¼ í‘œí˜„í•œ JSONì„ ì‘ë‹µ")
    public void testCreate() throws Exception {
        // given
        // userService.createUser ì •ì˜
        String username = "subin";
        UserDto requestDto = new UserDto(
                null, username, null, null, null, null
        ); // requestDto ë°ì´í„° ë³´ë‚´ëŠ” ìš©ë„
        UserDto responseDto = new UserDto(
                1L, username, null, null, null, null
        );
        when(userService.create(any()))
                .thenReturn(responseDto);
```
- ìš”ì²­ìœ¼ë¡œ ë³´ë‚¼ `UserDto`ë¥¼ ìƒì„± 
- í•´ë‹¹ `UserDto`ì™€ ë™ì¼í•œ `username`ì„ ê°€ì§€ê³  `id`ë„ `1L`ì„ ê°€ì§€ëŠ” `UserDto`ë¥¼ ë°˜í™˜


```java
        // when
        // perform: HTTP ìš”ì²­ì´ ë³´ë‚´ì¡Œë‹¤ê³  ê°€ì •
        ResultActions result = mockMvc.perform(
                // post ìš”ì²­ì„ ë³´ë‚¸ë‹¤.
                post("/user")
                        // ì´ ìš”ì²­ì˜ BodyëŠ” requestDtoë¥¼ JSONìœ¼ë¡œ ë³€í™˜í•œê²ƒ
                        .content(JsonUtil.toJson(requestDto))
                        // ì´ ìš”ì²­ì˜ BodyëŠ” JSONì´ë¼ê³  ìƒê°í•˜ê³  ì´í•´í•  ê²ƒ
                        .contentType(MediaType.APPLICATION_JSON)
        );

        // then
        // ì‘ë‹µì˜ ì½”ë“œê°€ 2xx
        // ë‚´ìš©ì´ JSON
        // usernameì´ ë³€í™”í•˜ì§€ ì•Šì•˜ë‹¤.
        // idê°€ nullì´ ì•„ë‹ˆë‹¤.
        result.andExpectAll(
                // 2xxë²ˆëŒ€(ì„±ê³µ) ìƒíƒœì½”ë“œ
                status().is2xxSuccessful(),
                // JSON ì‘ë‹µì„ ì£¼ì—ˆë‹¤.
                content().contentType(MediaType.APPLICATION_JSON),
                // JSONì— usernameì´ë¼ëŠ” ê°’ì´ ì „ë‹¬ëœ usernameê³¼ ë™ì¼í•˜ë‹¤.
                jsonPath("$.username",is(username)),
                // idëŠ” nullì´ ì•„ë‹ë‚˜.
                jsonPath("$.id",notNullValue())
        );
    }
```
- `mockMvc.perform()` ë©”ì„œë“œë¥¼ ì´ìš©í•˜ë©´ HTTP ìš”ì²­ì„ ë³´ëƒˆë‹¤ê³  ê°€ì •í•  ìˆ˜ ìˆìŒ
- ì „ë‹¬í•˜ëŠ” ì¸ìë¡œ ìš”ì²­ì˜ ì„¸ë¶€ì‚¬í•­ ì¡°ì • ê°€ëŠ¥
- `post()` ë©”ì„œë“œë¥¼ ì´ìš©í•´ URLì„ ì •ì˜, 
  - ë¹Œë” íŒ¨í„´ í˜•ì‹ìœ¼ë¡œ `.content()`ë¡œ Request Body
  - `.contentType()`ìœ¼ë¡œ `Content-Type`í—¤ë”ë¥¼ ì •ì˜
- `perform()` ë©”ì„œë“œì˜ ê²°ê³¼ì— `andExpectAll()` ë©”ì„œë“œë¡œ ì—¬ëŸ¬ `assert`ìƒí™© ê°€ì • ê°€ëŠ¥
  - `status()` : ì‘ë‹µ ìƒíƒœ ì½”ë“œë¥¼ ê²€ì¦
  - `content().contentType()` : ì‘ë‹µ `Content-Type`ì„ í™•ì¸
  - `jsonPath()` : JsonPath í˜•ì‹ìœ¼ë¡œ ì‘ë‹µë°›ì€ JSON ë°ì´í„°ì˜ ë‚´ìš©ë¬¼ì´ ê¸°ëŒ€í•œ ëŒ€ë¡œ ì‘ë‹µë˜ì—ˆëŠ”ì§€ í™•ì¸
---
### `User` ìƒì„± í†µí•© í…ŒìŠ¤íŠ¸
- í†µí•© í…ŒìŠ¤íŠ¸ëŠ” `Controller`ë¡œ ë¶€í„° `Service`, `Repository`ë¥¼ ê±°ì³ ê°œë°œí•œ ê¸°ëŠ¥ì´ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê³¼ì •
- `UserControllerIntegrationTests.java`
```java
@SpringBootTest(classes = ContentsApplication.class)
@AutoConfigureMockMvc
public class UserControllerIntegrationTests {
    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private UserRepository userRepository;

    //...
}
```
- ê·¸ë™ì•ˆ `Mock`ì„ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì— í•„ìš”í–ˆë˜ `ExtendWith`ëŠ” ë”ì´ìƒ ì‚¬ìš© x
- ëŒ€ì‹  `@SpringBootTest`, `@AutoConfigureMockMvc` í™œìš©
- `@AutoConfigureMockMvc`ëŠ” `MockMvcBuilders`ë¥¼ ì´ìš©í•´ ìˆ˜ë™ìœ¼ë¡œ ì œì‘í•œ `mockMvc`ë¥¼ ìë™ìœ¼ë¡œ Bean ê°ì²´ë¡œ ë§Œë“¤ì–´ ì¤Œ
  - ì´ë¥¼ `@AutoWired`ë¥¼ í†µí•´ ì‚¬ìš©
- `UserRepository` ë˜í•œ ì£¼ì…ë°›ì•„ í™œìš©
  - ì´ì œ ì „ì²´ íë¦„ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ë‹¨ê³„ì´ê¸° ë•Œë¬¸ì—, ì‘ë‹µì´ ì •ìƒì ìœ¼ë¡œ ë³´ë‚´ì§„ ê²½ìš° ì‹¤ì œë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ
  - ì‹¤ì œ `JpaRepository` ê°ì²´!
```java
@SpringBootTest(classes = ContentsApplication.class)
@AutoConfigureMockMvc
public class UserIntegrationTests {
    @Autowired
    private MockMvc mockMvc;

    @Autowired
    private UserRepository userRepository;

    @Test
    @DisplayName("User ìƒì„± í†µí•© í…ŒìŠ¤íŠ¸")
    public void whenPostUserDto_thenReturnJson()
            throws Exception {
        // Postí•  UserDto ì¤€ë¹„
        String username = "subin";
        String email = "subin@fakemail.mail";
        String phone = "01012345678";
        UserDto userDto = new UserDto(
                null,
                username,
                email,
                phone,
                null,
                null
        );

     /*
     mockMvc.perform(
                post("/users")
                        .content(JsonUtil.toJson(userDto))
                        .contentType(MediaType.APPLICATION_JSON)
        )
                .andExpectAll(
                        status().is2xxSuccessful(),
                        content().contentType(MediaType.APPLICATION_JSON),
                        jsonPath("$.id", notNullValue()),
                        jsonPath("$.username", is(username)),
                        jsonPath("$.email", is(email)),
                        jsonPath("$.phone", is(phone))
        );
        */


        // mockMvcë¥¼ ì´ìš©í•´ UserDtoë¥¼ ë³´ë‚¸ ê²°ê³¼ë¥¼ ë°›ê³ 
        ResultActions resultActions = mockMvc.perform(post("/user")
                .content(JsonUtil.toJson(userDto))
                .contentType(MediaType.APPLICATION_JSON));


        // í•´ë‹¹ mockMvcê°€ ë°˜í™˜í•œ ê²°ê³¼ë¥¼ ê¸°ì¤€ì„ ê°€ì§€ê³  í™•ì¸í•œë‹¤.
        resultActions.andExpectAll(
                status().is2xxSuccessful(),
                content().contentType(MediaType.APPLICATION_JSON),
                jsonPath("$.id", notNullValue()),
                jsonPath("$.username", is(username)),
                jsonPath("$.email", is(email)),
                jsonPath("$.phone", is(phone))
        );

        // DBì— ì˜ ë“¤ì–´ê°”ëŠ”ì§€ë„ í™•ì¸í•œë‹¤.
        assertTrue(userRepository.existsByUsername(username));
    }
}
```