## JWT
### HandlerInterceptor & Filter
> ğŸ’¡`íš¡ë‹¨ ê´€ì‹¬/ê´€ì ` : ì„œë¡œ ë‹¤ë¥¸ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì´ ê³µí†µì ìœ¼ë¡œ ê°€ì¡Œìœ¼ë©´ í•˜ëŠ” ê¸°ëŠ¥    
![íš¡ë‹¨ ê´€ì ](íš¡ë‹¨ê´€ì .png)

- Springì—ì„œ ìš”ì²­ê³¼ ì‘ë‹µ ì „í›„ë¡œ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” ë°©ë²• 2ê°€ì§€
  - `HandlerInterceptor`
  - `Filter`
----
`HandlerInterceptor`: Spring Frameworkì˜ ì¼ë¶€ë¶„
- `DispatcherServlet`ì´ HandlerMethodë¡œ ìš”ì²­ì„ ë„˜ê¸°ê¸° ì „ì— ì‹¤í–‰
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ì—°ê´€ì„±ì´ ë†’ì€ ê¸°ëŠ¥ êµ¬í˜„      


`Filter`: Jakarta Servlet APIì˜ ì¼ë¶€ë¶„
- `DispatcherServlet`ì— ë„ë‹¬í•˜ê¸° ì „ì— ìš”ì²­ì„ ê²€ì‚¬í•  ìˆ˜ ìˆìŒ
- Spring ì™¸ë¶€ì˜ ê¸°ëŠ¥ì´ë¯€ë¡œ, ì˜ˆì™¸ì²˜ë¦¬ ë“±ì—ì„œ Spring Frameworkì˜ ë„ì›€ì„ ë°›ì§€ ëª»í•¨
- ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¬´ê´€í•œ ê¸°ëŠ¥ êµ¬í˜„ì— ì‚¬ìš©   


---
### `HnadlerInterceptor`
ì¸í„°ì…‰í„°ë¥¼ ë§Œë“¤ê³  ì‹¶ì€ ê²½ìš° `HandlerInterceptor` ì¸í„°í˜ì´ìŠ¤ë¥¼ **ìƒì†**ë°›ëŠ” êµ¬í˜„ì²´ ìƒì„±
- `preHandle`: HandlerMethodê°€ ì‹¤í–‰ë˜ê¸° ì „ì— ì‹¤í–‰
- `postHandle`: HandlerMethodê°€ ì‹¤í–‰ í›„, ì‘ë‹µì´ ì „ë‹¬ë˜ê¸° ì „, Viewì˜ ë‚´ë¶€ë¥¼ ì±„ì›Œ ë„£ê¸° ì „ ì‹¤í–‰
- `afterCompletion`: ìš”ì²­ì˜ ì²˜ë¦¬ê°€ ë§ˆë¬´ë¦¬ ëœ ë’¤, ì˜ˆì™¸ ë°œìƒ ì‹œ ì˜ˆì™¸ ì •ë³´ê°€ ì¸ìë¡œ ì¶”ê°€ë¨

```java
@Component
public class HeaderLoggingInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(
            HttpServletRequest request,
            HttpServletResponse response,
            Object handler
    ) throws IOException {
        return true;
    }

    @Override
    public void postHandle(
            HttpServletRequest request,
            HttpServletResponse response,
            Object handler,
            ModelAndView modelAndView
    ) {}

    @Override
    public void afterCompletion(
            HttpServletRequest request,
            HttpServletResponse response,
            Object handler, Exception ex
    ) {}
}
```
- `preHandle` ë©”ì„œë“œì—ì„œ ë°˜í™˜í•˜ëŠ” `true` ë˜ëŠ” `false`ì— ë”°ë¼ ìš”ì²­ ì²˜ë¦¬ ê²°ì •
  - ì¦‰,`postHandle`/`afterCompletion`ì€ ì‹¤í–‰ ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ
  - ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí•  ê²½ìš° `postHandle`ì‹¤í–‰ x
- `HandlerInterceptor` ìƒì„± í›„ `Configuration`ì„ ì´ìš©í•´ ì‹¤í–‰ ì„¤ì • ê°€ëŠ¥
  - `WebMvcConfigurer` ìƒì† í›„ `addInterceptors` ë©”ì„œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í•´ì„œ interceptorë¥¼ ë“±ë¡


```java
@Configuration
@RequiredArgsConstructor
public class InterceptorConfig implements WebMvcConfigurer {
    private final LoggingInterceptor loggingInterceptor;
    @Override
    // ì¸í„°ì…‰í„°ë¥¼ ë“±ë¡í•˜ê¸° ìœ„í•œ ë©”ì„œë“œ
    public void addInterceptors(InterceptorRegistry registry) {
        registry
                // ì–´ë–¤ ì¸í„°ì…‰í„°ë¥¼
                .addInterceptor(loggingInterceptor)
                // ì–´ë–¤ ê²½ë¡œì—
                .addPathPatterns("/tests");
    }
}
```
- `HandlerInterceptor` ì‘ë™ ì›ë¦¬ ìƒ, `DispatcherServlet`ì´ `HandlerMethod`ì— ìš”ì²­ì„ ì´ê´€í•˜ê¸° ì „ ì‹¤í–‰
  - ì‹¤ì œ ìš”ì²­ ë° ì‘ë‹µ ë°ì´í„°(body)ë¥¼ í™œìš©í•˜ê¸° ì–´ë ¤ì›€

---
### `Filter`
í•„í„°ë¥¼ ë§Œë“¤ê³  ì‹¶ì€ ê²½ìš° `Filter`ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„
- Spring Bootì˜ ê²½ìš° `Filter`ì¸í„°í˜ì´ìŠ¤ êµ¬í˜„ , Bean ê°ì²´ë¡œ ë“±ë¡ => `Filter` ìë™ìœ¼ë¡œ ì‚¬ìš©
- `Filter`ëŠ” `doFilter()` ë©”ì„œë“œ í•˜ë‚˜ë§Œ êµ¬í˜„

```java
@Slf4j
@Component
public class LogFilter implements Filter {
    @Override
    public void doFilter(
            ServletRequest request,
            ServletResponse response,
            FilterChain chain
    ) throws IOException, ServletException {
        HttpServletRequest httpServletRequest = (HttpServletRequest) request;
        log.info("start request: {} {}",
                httpServletRequest.getMethod(),
                httpServletRequest.getRequestURI()
        );

        ContentCachingRequestWrapper requestWrapper
                = new ContentCachingRequestWrapper(httpServletRequest);

        // doFilterë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì„ ê²½ìš° ë‹¤ìŒ í•„í„°ê°€ ì‹¤í˜„ë˜ì§€ ì•Šìœ¼ë©°
        // -> ìš”ì²­ì´ ëê¹Œì§€ ì „ë‹¬ë˜ì§€ ì•ŠëŠ”ë‹¤.
        // --- ì´ ìœ„ëŠ” ìš”ì²­ ì²˜ë¦¬ ì „
        chain.doFilter(requestWrapper, response);
        // --- ì´ ì•„ë˜ëŠ” ìš”ì²­ ì²˜ë¦¬ í›„

        // doFilterì „ì— í˜¸ì¶œí•˜ë©´ ì˜¤ë¥˜ê°€ ë‚˜ì§€ëŠ” ì•Šì§€ë§Œ ë¡œê·¸ê°€ ì°íˆì§€ë„ ì•ŠëŠ”ë‹¤.
        log.info(new String(
                requestWrapper.getContentAsByteArray(), StandardCharsets.UTF_8));

        HttpServletResponse httpServletResponse = (HttpServletResponse) response;
        log.info("send response: {}", httpServletResponse.getStatus());
    }
}

```
- `Filter`ì˜ ê²½ìš° Servlet APIë¥¼ ë°”ë¡œ í™œìš©
  - `ServletRequest`/`ServletResponse` ì§ì ‘ ì»¤ìŠ¤í…€ í•´ì„œ ì‚¬ìš© ê°€ëŠ¥
  - `Interceptor` ë³´ë‹¤ í™œìš©ë„ ìì²´ëŠ” ë†’ìŒ
  - But, Spring ì—ì„œ ì œê³µí•˜ëŠ” ë‹¤ì–‘í•œ í¸ì˜ ê¸°ëŠ¥ í™œìš© ì–´ë ¤ì›€