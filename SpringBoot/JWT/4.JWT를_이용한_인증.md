## JWT
### JWTë¥¼ ì´ìš©í•œ ì¸ì¦

> ğŸ’¡ Authorization: Bearer
> - ì¼ë°˜ì ìœ¼ë¡œ JWTëŠ” Http Headerì— `Authorization`ì´ë¼ëŠ” Header ì¶”ê°€í•´ì„œ ì „ë‹¬
> - í† í°ì„ í™œìš©í•´ ì§„í–‰í•  ê²½ìš° `Bearer {token ê°’}`ì˜ í˜•íƒœë¡œ ì „ì†¡   
    > => Bearer Token Authentication

- FrontEndìª½ì—ì„œ ì§ì ‘ í•´ì£¼ì–´ì•¼ í•¨(<=> cookie-session ë°©ì‹(ì„œë²„ì—ì„œ ì¡°ì‘))
    - í´ë¼ì´ì–¸íŠ¸ê°€ Headerì— JWTë¥¼ ëŠ¥ë™ì ìœ¼ë¡œ ì¶”ê°€
    - í† í°ì˜ ë³´ê´€ë„ í´ë¼ì´ì–¸íŠ¸ê°€ ì§ì ‘ ì§„í–‰
    - ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì— ëŒ€í•œ ë°ì´í„° ì €ì¥ X


- `JwtTokenFilter` ìƒì„±í•´ì•¼ í•¨
    - ë“¤ì–´ì˜¨ HTTP ìš”ì²­ì— `Authorization` í—¤ë”ê°€ ì¡´ì¬í•˜ëŠ”ì§€ï¸ âœ”
    - ì¡´ì¬í•œë‹¤ë©´ ë‹´ê¸´ ê°’ì´ `Bearer`ë¡œ ì‹œì‘í•˜ëŠ”ì§€ âœ”
    - ë‹´ê²¨ ìˆëŠ” Tokenì´ ìœ íš¨í•œì§€ âœ”

----
### `JwtTokenFilter`
JWT í¬í•¨ëœ ìš”ì²­ì˜ ì¸ì¦ ë°©ë²•
1. ìš”ì²­ì— `Authorization` í—¤ë”ê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸ / ì—†ë‹¤ë©´ ë¹„ì¸ì¦ ì‚¬ìš©ì
2. `Header`ê°€ `Bearer`ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸ / ì•„ë‹ˆë¼ë©´ ì˜ëª»ëœ ì¸ì¦ì •ë³´, ë¹„ì¸ì¦ ì‚¬ìš©ì
3. `Header`ì˜ ê°’ ì¤‘ JWT ë¶€ë¶„ì´ ì •ìƒì ì¸ì§€ JWTì¸ì§€ íŒë‹¨ / ì•„ë‹ˆë¼ë©´ ì˜ëª»ëœ JWTë¡œ ë¹„ì¸ì¦ ì‚¬ìš©ì
4. JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ í•´ì„í•´ ì¸ì¦ìƒíƒœ ê¸°ë¡ ë° ì¸ì¦ì´ í•„ìš”í•œ ê²½ë¡œ í—ˆë½
----
### `JwtTokenUtils.validate()`
JWTê°€ ì •ìƒì ì¸ì§€(ìœ íš¨í•œì§€) íŒë‹¨í•˜ëŠ” ë©”ì„œë“œ
- jjwt ë¼ì´ë¸ŒëŸ¬ë¼ëŠ” JWTí•´ì„ ê³¼ì •ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ì˜ˆì™¸ ë°œìƒ
- ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ë¹„ì •ìƒ JWT
- Keyì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ JWT ì •ë³´ë¥¼ í•´ì„í•˜ëŠ” `JwtParser`í´ë˜ìŠ¤ë¥¼ í•„ë“œë¡œ í• ë‹¹
```java
    // JWTë¥¼ ë§Œë“œëŠ” ìš©ë„ì˜ ì•”í˜¸í‚¤
private final Key signingKey;
// JWTë¥¼ í•´ì„í•˜ëŠ” ìš©ë„ì˜ ê°ì²´
private final JwtParser jwtParser;

public JwtTokenUtils(
    @Value("${jwt.secret}")
    String jwtSecret
) {
        log.info(jwtSecret);
        this.signingKey
                = Keys.hmacShaKeyFor(jwtSecret.getBytes());
        this.jwtParser = Jwts
                .parserBuilder()
                .setSigningKey(this.signingKey)
                .build();
}
```
- ì•”í˜¸í™” ëœ JWTë¥¼ ì‚¬ìš©í•˜ê³  ìˆê¸° ë•Œë¬¸ì— `.parseClaimsJws()`ì´ìš©í•´ ì •ë³´ í•´ì„
```java
// ì •ìƒì ì¸ JWTì¸ì§€ë¥¼ íŒë‹¨í•˜ëŠ” ë©”ì„œë“œ(ê°„ë‹¨í•œ ë²„ì „)
    public boolean validate(String token) {
        try {
        // ì •ìƒì ì´ì§€ ì•Šì€ JWTë¼ë©´ ì˜ˆì™¸(Exception)ê°€ ë°œìƒí•œë‹¤.
            jwtParser.parseClaimsJws(token);
            return true;
        } catch (Exception e){
            log.warn("invalid jwt");
        }
        return false;
    }
```
----
### `OncePerRequestFilter`
- í•„í„°ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ëŠ” ì¶”ìƒ í´ë˜ìŠ¤
- ë¹„ë™ê¸° ì²˜ë¦¬ ë˜ëŠ” forward/ redirect ë“±ì˜ íŠ¹ì • ìƒí™©ì—ì„œ Filterì˜ ê¸°ëŠ¥ì´ ë³µìˆ˜ë²ˆ ì‚¬ìš©ë  ìˆ˜ ìˆì„ ê²½ìš°
- ì‹¤ì œë¡œëŠ” í•œë²ˆë§Œ ì‚¬ìš©ë˜ë„ë¡ ë³´ì¥í•˜ëŠ” Filter ê°ì²´
> âš ï¸ `JwtTokenFilter` ë¥¼ Bean ê°ì²´ë¡œ ë“±ë¡í•˜ê²Œë  ê²½ìš°,
> Spring Containerê°€ í•„í„°ë¥¼ ê²€ìƒ‰í•˜ê³ , 
> Spring Securityì—ì„œ í•„í„°ë¥¼ ë‹¤ì‹œ ë“±ë¡ì„ í•´ì„œ ë˜‘ê°™ì€ í•„í„°ê°€ ë‘ë²ˆ ë“±ë¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì—¬ê¸°ì„œëŠ” Bean ê°ì²´ë¡œ ë“±ë¡í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```java
@Slf4j
public class JwtTokenFilter extends OncePerRequestFilter {
    private final JwtTokenUtils jwtTokenUtils;
    public JwtTokenFilter(
            JwtTokenUtils jwtTokenUtils
    ) {
        this.jwtTokenUtils = jwtTokenUtils;
    }
}
```
ì´ í´ë˜ìŠ¤ë¥¼ ìƒì†ë°›ìœ¼ë©´ ì¼ë°˜ì ì¸ `doFilter`ëŒ€ì‹  `doFilterInternal`ì„ êµ¬í˜„
```java
@Override
protected void doFilterInternal(
        HttpServletRequest request, 
        HttpServletResponse response, 
        FilterChain filterChain
) throws ServletException, IOException {
    filterChain.doFilter(request, response);
}
```
1. `filterChain.doFilter()` í˜¸ì¶œ: `FilterChain`ì˜ ë‹¤ìŒ Filter ì‹¤í–‰
2. `httpServletResponse`ì˜ ë‚´ìš© ì‘ì„± ë° `filterChain.doFilter()`ë¯¸í˜¸ì¶œ: `FilterChain`ì²˜ë¦¬ ì¤‘ë‹¨, ì¦‰ ì´ Filterê¹Œì§€ë§Œ ì‚¬ìš©

----
- Authorizationí—¤ë” ì¡´ì¬ í™•ì¸ 
- ì¡´ì¬í•œë‹¤ë©´ í—¤ë”ê°€ `Bearer`ë¡œ ì‹œì‘
- ë’¤ì˜ JWT ìœ íš¨í•œì§€ íŒë‹¨
```java
@Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain
    ) throws ServletException, IOException {
        log.debug("try jwt filter");
        // 1. Authorization í—¤ë”ë¥¼ íšŒìˆ˜
        String authHeader
                // = request.getHeader("Authorization");
                = request.getHeader(HttpHeaders.AUTHORIZATION);
        // 2. Authorization í—¤ë”ê°€ ì¡´ì¬í•˜ëŠ”ì§€ + Bearerë¡œ ì‹œì‘í•˜ëŠ”ì§€
        if(authHeader != null&& authHeader.startsWith("Bearer ")) {
            String token = authHeader.split(" ")[1];
            // 3. Token ì´ ìœ íš¨í•œ í† í°ì¸ì§€
            if (jwtTokenUtils.validate(token)){
                // 4. ìœ íš¨í•˜ë‹¤ë©´ í•´ë‹¹ í† í°ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ SecurityContextì— ë“±ë¡
                SecurityContext context = SecurityContextHolder.createEmptyContext();
                // ì‚¬ìš©ì ì •ë³´ íšŒìˆ˜
                String username = jwtTokenUtils
                        .parseClaims(token)
                        .getSubject();
                // ì¸ì¦ ì •ë³´ ìƒì„±
                AbstractAuthenticationToken authenticationToken
                        = new UsernamePasswordAuthenticationToken(
//                        CustomUserDetails.builder()
//                                .username(username)
//                                .build(),/
                        // managerì—ì„œ ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
                        manager.loadUserByUsername(username),
                        token, new ArrayList<>()
                );
                // ì¸ì¦ ì •ë³´ ë“±ë¡
                context.setAuthentication(authenticationToken);
                SecurityContextHolder.setContext(context);
                log.info("set security context with jwt");
            }
            else {
                log.warn("jwt validation failed");
            }
        }
        // 5. ë‹¤ìŒ í•„í„° í˜¸ì¶œ
        // doFilterë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ Controller ê¹Œì§€ ìš”ì²­ì´ ë„ë‹¬í•˜ì§€ ëª»í•œë‹¤.
        filterChain.doFilter(request, response);
    }
```
----
### `SecurityContext`
- `SecurityContextHolder`: ì¸ì¦ì´ ëœ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ê¸° ì „ì— ì‚¬ìš©í•´ ë´£ìŒ
- ì¸ì¦ì— ì„±ê³µí•œ ì‚¬ìš©ìë¥¼ ì €ì¥í•˜ë©´ Spring Securityê°€ ì‚¬ìš©ìë¥¼ ì¸ì¦ëœ ì‚¬ìš©ìë¡œ íŒë‹¨
- ì´ë•Œ ë§Œë“¤ì–´ì„œ ì €ì¥í•˜ëŠ” ê°ì²´ëŠ” `Authentication`ì˜ êµ¬í˜„ì²´, ì¼ë°˜ì ìœ¼ë¡œëŠ” `UsernamePasswordAuthenticationToken`ì„ êµ¬í˜„ì²´ë¡œ í™œìš©


- ì‚¬ìš©ìê°€ ì •ìƒ ì‚¬ìš©ìë¼ë©´
    - í•´ë‹¹ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ `Authentication` ìƒì„±
    - `SecurityContextHolder`ì— ìƒˆë¡œìš´ `Authentication`ë“±ë¡
```java
// ì‹¤ì œ ë°ì´í„°(Payload)ë¥¼ ë°˜í™˜í•˜ëŠ” ë©”ì„œë“œ
    public Claims parseClaims(String token){
        return jwtParser
                .parseClaimsJws(token)
                .getBody();
    }
```
- í•´ë‹¹ ë©”ì„œë“œë¥¼ í™œìš©í•´ `SecurityContext`ë¥¼ ìƒì„±ìƒˆ `SecurityContextHolder`ë¡œ ì „ë‹¬
```java
    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain
    ) throws ServletException, IOException {
        log.debug("try jwt filter");
        // 1. Authorization í—¤ë”ë¥¼ íšŒìˆ˜
        String authHeader
                // = request.getHeader("Authorization");
                = request.getHeader(HttpHeaders.AUTHORIZATION);
        // 2. Authorization í—¤ë”ê°€ ì¡´ì¬í•˜ëŠ”ì§€ + Bearerë¡œ ì‹œì‘í•˜ëŠ”ì§€
        if(authHeader != null&& authHeader.startsWith("Bearer ")) {
            String token = authHeader.split(" ")[1];
            // 3. Token ì´ ìœ íš¨í•œ í† í°ì¸ì§€
            if (jwtTokenUtils.validate(token)){
                // 4. ìœ íš¨í•˜ë‹¤ë©´ í•´ë‹¹ í† í°ì„ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ SecurityContextì— ë“±ë¡
                SecurityContext context = SecurityContextHolder.createEmptyContext();
                // ì‚¬ìš©ì ì •ë³´ íšŒìˆ˜
                String username = jwtTokenUtils
                        .parseClaims(token)
                        .getSubject();
                // ì¸ì¦ ì •ë³´ ìƒì„±
                AbstractAuthenticationToken authenticationToken
                        = new UsernamePasswordAuthenticationToken(
//                        CustomUserDetails.builder()
//                                .username(username)
//                                .build(),/
                        // managerì—ì„œ ì‹¤ì œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
                        manager.loadUserByUsername(username),
                        token, new ArrayList<>()
                );
                // ì¸ì¦ ì •ë³´ ë“±ë¡
                context.setAuthentication(authenticationToken);
                SecurityContextHolder.setContext(context);
                log.info("set security context with jwt");
            }
            else {
                log.warn("jwt validation failed");
            }
        }
        // 5. ë‹¤ìŒ í•„í„° í˜¸ì¶œ
        // doFilterë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ Controller ê¹Œì§€ ìš”ì²­ì´ ë„ë‹¬í•˜ì§€ ëª»í•œë‹¤.
        filterChain.doFilter(request, response);
    }
```
----
### ì„¤ì • ë° í…ŒìŠ¤íŠ¸
- í•„í„°ë¥¼ `WebSecurityConfig`ë¥¼ í†µí•´ `FilterChain`ì— ë“±ë¡
- `JwtTokenUtils`ì£¼ì…, `JwtTokenFilter`ëŠ” ìˆ˜ë™ìœ¼ë¡œ ìƒì„±
```java
@Configuration
@RequiredArgsConstructor
public class WebSecurityConfig {

    private final JwtTokenUtils jwtTokenUtils;
    // ...
```
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http)
    throws Exception {
    http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(
                    authHttp -> authHttp
                            .requestMatchers(
                                    "/no-auth",
                                    "/token/issue",
                                    "/users/login"
                            )
                            .permitAll()
                            .requestMatchers(
                                    "/",
                                    "/users/register"
                            )
                            .anonymous()
                            .anyRequest()
                            .authenticated()
            )
            .sessionManagement(
                    sessionManagement -> sessionManagement
                            .sessionCreationPolicy(
                                    SessionCreationPolicy.STATELESS)
            )
            .addFilterBefore(
                    new JwtTokenFilter(jwtTokenUtils), 
                    AuthorizationFilter.class
            );
    return http.build();
}
```
- `POST /token/issue`ìš”ì²­ì„ í†µí•´ JWT ë°œê¸‰ë°›ê³  ì¸ì¦ì´ í•„ìš”í•œ URLì— JWTë¥¼ í¬í•¨ì‹œì¼œ ìš”ì²­ì„ ë³´ë‚¼ ìˆ˜ ìˆìŒ
