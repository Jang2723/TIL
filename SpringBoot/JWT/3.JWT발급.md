## JWT
[JWT GITHUB](https://github.com/Jang2723/Spring-Security-auth-)
> ðŸ’¡ JWT    
> -  JSON Web Token     
> -  JSONìœ¼ë¡œ í‘œí˜„ëœ ì •ë³´ë¥¼ ì•ˆì „í•˜ê²Œ ì£¼ê³ ë°›ê¸° ìœ„í•œ Tokenì˜ ì¼ì¢…


1. ë‚´ë¶€ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì‚¬ìš©ìž ì¸ì¦ ì •ë³´
2. JWT ìœ„ë³€ì¡° í™•ì¸ ìš©ì´ => ìœ„ë³€ì¡°ê°€ ì–´ë ¤ì›€
    - ì½ëŠ”ê²Œ ì–´ë ¤ìš´ ê²ƒì´ ì•„ë‹˜, ***ìœ„ë³€ì¡°***ê°€ ì–´ë ¤ìš´ ê²ƒ!
3. í† í° ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œì—ì„œ ë§Žì´ í™œìš©

```text
header.payload.signature
```
- `header`: JWTì˜ ë¶€ìˆ˜ì ì¸ ì •ë³´(ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì•”í˜¸í™” ë˜ì—ˆëŠ”ì§€)
- `payload`: JWTë¡œ ì „ë‹¬í•˜ê³ ìž í•˜ëŠ” ì •ë³´(`Claim`)ê°€ ë‹´ê¸´ ë¶€ë¶„
  - `sub`: suject, ì‚¬ìš©ìž
  - `iat`: issued at, ë°œê¸‰ ì¼ìž
  - `exp`: expires, ë§Œë£Œì¼ìž
- `signature`: JWTì˜ ìœ„ë³€ì¡° íŒë‹¨ì„ ìœ„í•œ ë¶€ë¶„
  - `haedr`,`payload`ì˜ ê¸¸ì´, ì‚¬ì „ì— ê³µìœ ëœ ì•”í˜¸í‚¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `signature`ê³„ì‚° í›„ ìœ„ë³€ì¡° ê°ì§€


> ðŸ’¡ Token Based Authentication
> - ì„¸ì…˜ì„ ì €ìž¥í•˜ì§€ ì•Šê³  í† í°ì˜ ì†Œìœ ë¥¼ í†µí•´ ì¸ì¦ íŒë‹¨

- ìƒíƒœë¥¼ ì €ìž¥í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, ì„œë²„ì˜ ì„¸ì…˜ ê´€ë¦¬ê°€ ë¶ˆí•„ìš”   


- í† í° ì†Œìœ ê°€ ê³§ ì¸ì¦, ì—¬ëŸ¬ ì„œë²„ì— ê±¸ì³ì„œ ì¸ì¦ì´ ê°€ëŠ¥
  - => ë°”íƒ•ìœ¼ë¡œ SSOë¥¼ ë§Œë“¤ê¸°ë„ í•¨
  - SSO(Single Sign On): 1íšŒ ì‚¬ìš©ìž ì¸ì¦ìœ¼ë¡œ ë‹¤ìˆ˜ì˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ë° ì›¹ ì‚¬ì´íŠ¸ì— ëŒ€í•œ ì‚¬ìš©ìž ë¡œê¸ì¸ì„ í—ˆìš©í•˜ëŠ” ì¸ì¦ ì†”ë£¨ì…˜


- ì¿ í‚¤ëŠ” ìš”ì²­ì„ ë³´ë‚¸ í´ë¼ì´ì–¸íŠ¸ì— ì¢…ì†ë˜ì§€ë§Œ, í† í°ì€ ì‰½ê²Œ ì²¨êµ¬ê°€ ê°€ëŠ¥í•¨(ex. Header)   


- ë¡œê·¸ì¸ ìƒíƒœë¼ëŠ” ê°œë…ì´ x => ë¡œê·¸ì•„ì›ƒ ë¶ˆê°€
  - ë¡œê·¸ì•„ì›ƒì€ í”„ë¡ íŠ¸ì—ì„œ í† í° íê¸°ë¡œ ì§„í–‰ ê°€ëŠ¥ => í† í°ì˜ ì†Œìœ ê°€ ê³§ ì¸ì¦ì´ê¸° ë•Œë¬¸
#### build.gradle
```java
implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'
```
---
### JWT ë°œê¸‰
- JWTì™€ ê´€ë ¨ ê¸°ëŠ¥ë§Œ ë”°ë¡œ í´ëž˜ìŠ¤ì— ë‚˜ëˆˆë‹¤ê³  ê°€ì •, `JwtTokenUtils` ìƒì„±
```java
@Slf4j
@Component
public class JwtTokenUtils {}
```

### ì•”í˜¸í‚¤ ì¤€ë¹„
- JWTì˜ ìœ„ë³€ì¡° ìƒíƒœë¥¼ ê°ì§€í•˜ê¸° ìœ„í•œ ì•”í˜¸í‚¤ í•„ìš”
- ì ë‹¹í•œ ê¸¸ì´ì˜ ë¬¸ìžì—´ ì‚¬ìš©
- `application.yaml`ì— ìž‘ì„±
```yaml
jwt:
  secret: aaaabbbsdifqbvaesoioegwaaaabbbsdifqbvaesoioegwaaaabbbsdifqbvaes
```
- `application.yaml`ì— ìž‘ì„±ëœ ì„¤ì •ì€ í•„ë“œë‚˜ ìƒì„±ìž ì¸ìžì— `@Value` ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ í• ë‹¹ ê°€ëŠ¥   
- JWT ì•”í˜¸í™”ë¥¼ ìœ„í•œ ì•”í˜¸í‚¤ë¥¼ ë‚˜íƒ€ë‚´ëŠ” `Key` ì¸í„°íŽ˜ì´ìŠ¤ë¥¼ í•„ë“œë¡œ í• ë‹¹
```java
@Slf4j
@Component
public class JwtTokenUtils {
    private final Key signingKey;

    public JwtTokenUtils(
            @Value("${jwt.secret}")
            String jwtSecret
    ) {
        this.signingKey 
                = Keys.hmacShaKeyFor(jwtSecret.getBytes());
    }
}
```
---
### `generateToken()`
- JWT ë°œê¸‰ ë©”ì„œë“œ
```java
 // UserDetailsë¥¼ ë°›ì•„ì„œ JWTë¡œ ë³€í™˜í•˜ëŠ” ë©”ì„œë“œ
    public String generateToken(UserDetails userDetails) {
        // JWTì— ë‹´ê³ ì‹¶ì€ ì •ë³´ë¥¼ Claims ë¡œ ë§Œë“ ë‹¤.

        // í˜„ìž¬ í˜¸ì¶œë˜ì—ˆì„ ë•Œ epoch time
        Instant now = Instant.now();
        Claims jwtClaims = Jwts.claims()
                // sub: ëˆ„êµ¬ì¸ì§€
                .setSubject(userDetails.getUsername())
                // iat : ì–¸ì œ ë°œê¸‰ ë˜ì—ˆëŠ”ì§€
                .setIssuedAt(Date.from(now))
                // exp : ì–¸ì œ ë§Œë£Œ ì˜ˆì •ì¸ì§€
                .setExpiration(Date.from(now.plusSeconds(60 * 60 * 24 * 7)));

        jwtClaims.put("isAccountExpired", !userDetails.isAccountNonExpired());
        // ì¼ë°˜ì ì¸ JWT ì™¸ì˜ ì •ë³´ë¥¼ í¬í•¨í•˜ê³  ì‹¶ë‹¤ë©´
        // Map.put ì‚¬ìš© ê°€ëŠ¥
        // jwtClaims.put("test","claim");

        // ìµœì¢…ì ìœ¼ë¡œ JWTë¥¼ ë°œê¸‰í•œë‹¤.
        return Jwts.builder()
                .setClaims(jwtClaims)
                .signWith(this.signingKey)
                .compact();
    }
```
- `Claims`
  - JJWTì— ì •ì˜ëœ `Map` ì¸í„°íŽ˜ì´ìŠ¤ë¥¼ ìƒì†ë°›ëŠ” ì¸í„°íŽ˜ì´ìŠ¤
  - JWTì— ë‹´ê¸¸ ì •ë³´
  - `Map`ì²˜ëŸ¼ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì—¬ JWTì— í¬í•¨ì‹œí‚¬ ë°ì´í„° ì •ì˜ ê°€ëŠ¥
  - ì‚¬ìš©ìžë¥¼ ì‹ë³„í•  `username`, ë°œê¸‰ì¼ `iat`, ë§Œë£Œì¼ `exp`ì„¤ì •   


- `Jwts.builder()`: ì‹¤ì œ JWT ë§Œë“œëŠ” ë¹Œë”
  - `.compact()` ë©”ì„œë“œê°€ ì‹¤ì œ Tokenì„ ë¬¸ìžì—´ë¡œ ë§Œë“¤ì–´ ë°˜í™˜, `.build()`ì˜ ì—­í• 
---
### `TokenController`
- JWT ë°œê¸‰ë°›ì„ ì—”ë“œí¬ì¸íŠ¸
```java
@Slf4j
@RestController
@RequestMapping("token")
public class TokenController {
    private final JwtTokenUtils jwtTokenUtils;
    private final UserDetailsManager manager;
    private final PasswordEncoder passwordEncoder;

    public TokenController(
            JwtTokenUtils jwtTokenUtils,
            UserDetailsManager manager,
            PasswordEncoder passwordEncoder
    ) {
        this.jwtTokenUtils = jwtTokenUtils;
        this.manager = manager;
        this.passwordEncoder = passwordEncoder;
    }
}
```
- `jwtTokenUtils`: ì‹¤ì œë¡œ JWT ë°œê¸‰ë°›ê¸° ìœ„í•´ í•„ìš”í•œ Bean
- `UserDetailsManager`: ì‚¬ìš©ìž ì •ë³´ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•œ Bean
- `PasswordEncoder`: ì‚¬ìš©ìžê°€ JWT ë°œê¸‰ì„ ìœ„í•´ ì œì¶œí•˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ì•”í˜¸í™” Bean


#### `issue` ì—”ë“œí¬ì¸íŠ¸
```java
// POST /token/issue
@PostMapping("/issue")
public JwtResponseDto issueJwt(
@RequestBody JwtRequestDto dto
        ) {
        // ì‚¬ìš©ìžê°€ ì œê³µí•œ username, passordê°€ ì €ìž¥ëœ ì‚¬ìš©ìžì¸ì§€
        if (!manager.userExists(dto.getUsername()))
            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);

        UserDetails userDetails
        = manager.loadUserByUsername(dto.getUsername());

        // ë¹„ë°€ë²ˆí˜¸ ëŒ€ì¡°
        /*if (userDetails.getPassword()
                .equals(passwordEncoder.encode(dto.getPassword())))*/
        if (!passwordEncoder.matches(dto.getPassword(), userDetails.getPassword()))
            throw new ResponseStatusException(HttpStatus.UNAUTHORIZED);

        // JWT ë°œê¸‰
        String jwt = jwtTokenUtils.generateToken(userDetails);
        JwtResponseDto response = new JwtResponseDto();
        response.setToken(jwt);
        return response;
        }
```
---
### `WebSecurityConfig`
- JWT ì‚¬ìš©ì‹œ ë³¸ëž˜ ì‚¬ìš©í–ˆë˜ `formLogin`,`logout` ì‚¬ìš© x
- ì„¸ì…˜ì„ ê´€ë¦¬í•˜ì§€ ì•Šë„ë¡ ì„¤ì • => `.sessionManagement`
- í† í° ë°œê¸‰ì„ ìœ„í•œ `/token/issue` URLì„ ì¸ì¦ í•„ìš”ì—†ëŠ” ìƒíƒœë¡œ ì„¤ì •
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http)
    throws Exception {
    http
            .csrf(AbstractHttpConfigurer::disable)
            .authorizeHttpRequests(
                    authHttp -> authHttp
                            .requestMatchers(
                                    "/no-auth",
                                    "/token/issue"
                            )
                            .permitAll()
                            .requestMatchers(
                                    "/re-auth",
                                    "/users/my-profile"
                            )
                            .authenticated()
                            .requestMatchers(
                                    "/",
                                    "/users/register"
                            )
                            .anonymous()
            )
        
            .sessionManagement(
                    sessionManagement -> sessionManagement
                            .sessionCreationPolicy(
                                    SessionCreationPolicy.STATELESS)
            );
    
    return http.build();
}
```