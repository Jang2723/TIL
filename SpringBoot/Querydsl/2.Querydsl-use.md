## Querydsl ì‚¬ìš©í•´ë³´ê¸°
- Querydslì€ ì‘ì„±í•´ì•¼ í•˜ëŠ” SQL ë˜ëŠ” JPQLì„ ë§ˆì¹˜ [ë¹Œë” íŒ¨í„´](/Testing/Builder_Pattern.md)ì„ ì‚¬ìš©í•˜ë“¯ì´ ì‘ì„£í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ
- JPQLì„ ë¹Œë”ë¡œ ì‘ì„±í•˜ê¸° ì‹œì‘í•˜ê²Œ í•´ì£¼ëŠ” ê°ì²´ê°€ `JPAQueryFactory`
- ì¡°íšŒí•˜ê³ ì í•˜ëŠ” Entityì™€ ì†ì„±ì„ íƒ€ì… ì•ˆì •ì„±ì„ ê°€ì§€ê³  ë‚˜íƒ€ë‚´ê¸° ìœ„í•œ í´ë˜ìŠ¤ê°€ [`QType`](#qtype)í´ë˜ìŠ¤

> ğŸ’¡ íƒ€ì… ì•ˆì •ì„± : ì½”ë“œë¥¼ ì»´íŒŒì¼ í•˜ëŠ” ë™ì•ˆì— ì˜¤ë¥˜ ê°ì§€
---
### `JPAQueryFactory`
- ê¸°ë³¸ì ìœ¼ë¡œ Querydslê³¼ JPAë¥¼ ì‚¬ìš©í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê°ì²´
- JPQLì„ ë¹Œë”ì²˜ëŸ¼ ì‘ì„±í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ê°ì²´
- JPAë¥¼ ì‚¬ìš©í• ë•ŒëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì†Œí†µí•˜ëŠ” `EntityManager`ë¥¼ í•„ìš”ë¡œ í•¨
- Querydslë„ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ `EntityManager`ë¥¼ í™œìš©í•´ JPAë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì¿¼ë¦¬ë¥¼ ìƒì„±í•´ ì£¼ëŠ” í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©
- ì´ `EntityManagaer`ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì´ ì •ì˜ëœ í´ë˜ìŠ¤ê°€ `JPAQueryFactory`
- `EntityManager` ë¹ˆ ê°ì²´ë¥¼ ë°›ì•„ì˜¤ë©´, í•´ë‹¹ ë¹ˆ ê°ì²´ë¥¼ ì¸ìë¡œ ìƒˆë¡œìš´ `JPAQueryFactory`ë¥¼ ìƒì„± ê°€ëŠ¥
```java
@Slf4j
@Repository
public class QueryDslRepo {
    private final JPAQueryFactory queryFactory;

    public QueryDslRepo(EntityManager entityManager) {
        queryFactory = new JPAQueryFactory(entityManager);
    }
}
```
- `JPAQueryFactory`ë¥¼ `@Bean` ê°ì²´ë¡œ `@Configuration`ì— ë“±ë¡í•˜ê²Œ ë˜ë©´ í•„ìš”í•œ ì§€ì ì— ì˜ì¡´ì„± ì£¼ì…ì„ í†µí•´ í™œìš© ê°€ëŠ¥
```java
@Configuration
@EnableJpaAuditing
@RequiredArgsConstructor
public class JpaConfig {
    private final EntityManager entityManager;

    @Bean
    public JPAQueryFactory jpaQueryFactory() {
        return new JPAQueryFactory(entityManager);
    }
}
```
```java
@Slf4j
@Repository
@RequiredArgsConstructor
public class QueryDslRepo {
    private final JPAQueryFactory queryFactory;

//  public QueryDslRepo(EntityManager entityManager) {
//      queryFactory = new JPAQueryFactory(entityManager);
//  }
}
```

### `QType`
- Querydslì—ì„œ ìë™ìœ¼ë¡œ ìƒì„±í•´ì£¼ëŠ” í´ë˜ìŠ¤
- Querydslì˜ íƒ€ì… ì•ˆì •ì„±ì— ê¸°ì—¬í•˜ëŠ” ê°œë…
- QTypeì—ëŠ” JPQLì„ ì‘ì„±í•  ë•Œ ì‘ì„±í•´ì•¼ ë˜ëŠ” Entity ì´ë¦„, ì†ì„± ì´ë¦„ ë“±ì´ ì†ì„±ìœ¼ë¡œ ì ì˜ê°€ ë˜ì–´ ìˆìœ¼ë©°
- Querydslì„ ì´ìš©í•˜ëŠ” ê³¼ì •ì—ì„œ ì–´ë–¤ ì»¬ëŸ¼ì¸ì§€ì™€ ê°™ì€ ì •ë³´ë¥¼ ë¬¸ìì—´ í˜•íƒœë¡œ ì „ë‹¬í•  í•„ìš”ê°€ ì—†ê²Œë” í•´ì£¼ëŠ” í´ë˜ìŠ¤
- Querydsl ì˜ì¡´ì„±ì„ ì¶”ê°€í•˜ê³  ë¹Œë“œë¥¼ í–ˆì„ ë•Œ ìƒê¸´ `Q`ê°€ ë¶™ì€ í´ë˜ìŠ¤ë“¤ì´ `QType`í´ë˜ìŠ¤
```java
@Generated("com.querydsl.codegen.DefaultEntitySerializer")
public class QItem extends EntityPathBase<Item> {
    // ...
    public final NumberPath<Long> id = _super.id;
    public final StringPath name = createString("name");
    public final NumberPath<Integer> price = createNumber("price", Integer.class);
    public final NumberPath<Integer> stock = createNumber("stock", Integer.class);
    // ...
}
```
- [Entity](1.Querydsl.md#erd--entity--jpaconfig)ì—ì„œ ë§Œë“  ì†ì„±ë“¤ì´ ê°™ì€ ì´ë¦„ì„ ê°€ì§€ê³  ë‹¤ë¥´ ìë£Œí˜•ìœ¼ë¡œ ì •ì˜ë˜ì–´ ìˆëŠ” ëª¨ìŠµ í™•ì¸
- ì´ ì†ì„±ë“¤ì„ í™œìš©í•˜ë©´ ì¼ë°˜ì ìœ¼ë¡œ JPQLì—ì„œ ì†ì„±ì„ ì§€ì •í•˜ëŠ” ìƒí™©ì—ì„œ ì´ ì†ì„±ë“¤ì„ ì‚¬ìš© ê°€ëŠ¥
- Entity ìì²´ë¥¼ ì§€ì •í•˜ëŠ” ìƒí•­ì—ì„œëŠ” `QType` ê·¸ ìì²´ë¥¼ ì§€ì •í•˜ì—¬ íƒ€ì… ì•ˆì •ì„±ì„ ê°€ì ¸ê°ˆ ìˆ˜ ì‡ìŒ
- ğŸ’¡ ì¿¼ë¦¬ë¬¸ì„ ì§ì ‘ ì‘ì„±í•˜ì§€ ì•Šì•„ë„ ì¿¼ë¦¬ë¬¸ì˜ í˜•íƒœë¥¼ ê°–ì¶œ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” Querydslì˜ í•µì‹¬

### ê°„ë‹¨í•œ Query ë§Œë“¤ì–´ë³´ê¸°
- `JPAQeuryFactory`ëŠ” JPQL ë¹Œë”
- Querydslì€ ë¹Œë”ì²˜ëŸ¼ ì¿¼ë¦¬ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ
- ì‹œì‘ì€ `JPAQueryFactory`ë¶€í„°ì´ë©°, ì¡°íšŒí•˜ê³  ì‹¶ì€ ì—”í‹°í‹°ì— ëŒ€ì‘ë˜ëŠ” `QType`ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ `.select()`ì˜ ì¸ìë¡œ ì „ë‹¬
- `JPAQueryFactory`ì—ëŠ” SQLì„ ì‘ì„±í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ì ˆ(clause)ë“¤ì´ ë©”ì„œë“œë¡œ ì •ì˜ë˜ì–´ ìˆìŒ
- => Queryë¬¸ì˜ ê° ì ˆë“¤ì„ ë¹Œë”ì˜ ë©”ì„œë“œë¡œ ì‘ì„± ê°€ëŠ¥
```java
QItem qItem = new QItem("item");
Item found = queryFactory
        // SELECT ì ˆ (SELECT item)
        .select(qItem)
        // FROM ì ˆ (FROM Item item)
        .from(qItem)
        // WHERE ì ˆ (WHERE item.name = "itemA")
        .where(qItem.name.eq("itemA"))
        .fetchOne();
```
- ìœ„ì²˜ëŸ¼ `select`ì™€ `from`ì˜ ëŒ€ìƒì´ ë™ì¼í•˜ë‹¤ë©´ `selectFrom` ëŒ€ì‹  ì‚¬ìš© ê°€ëŠ¥
```java
QItem qItem = new QItem("item");
Item found = queryFactory
        // SELECT item FROM Item item
        .selectFrom(qItem)
        .where(qItem.name.eq("itemB"))
        .fetchOne();
```
- `new QItem("item")`ì— ì „ë‹¬í•˜ëŠ” `"item"`ì€ ì‹¤ì œë¡œ ì‘ì„±ë˜ëŠ” JPQL ì¿¼ë¦¬ì—ì„œ ì‚¬ìš©í•  `Item`ì˜ ë³„ì¹­(Alias)
- ì´ëŠ” `spring.jpa.properties.hibernate.show_sql`ê³¼ `spring.jpa.properties.hibernate.use_sql_comments` ë‘˜ë‹¤ `true`ë¡œ ì„¤ì •í•œ ê²½ìš° í™•ì¸ê°€ëŠ¥
```yaml
spring:
  # ...
  jpa:
    # ...
    properties:
      hibernate:
        show_sql: true
        # ì¶”ê°€ë¡œ ì¶œë ¥ì„ ì˜ˆì˜ê²Œ
        format_sql: true  
        use_sql_comments: true
```
- ì´ë¥¼ ë°”ê¿”ì„œ ì‹¤í–‰í•´ë³´ë©´ ë§Œë“¤ì–´ì§„ JPQLì˜ ë³„ì¹­ì´ ë°”ë€œ
```java
QItem qItem2 = new QItem("item2");
Item found = queryFactory
        // SELECT item2 FROM Item item2
        .selectFrom(qItem2)
        // WHERE item2.name = "itemC"
        .where(qItem2.name.eq("itemC"))
        .fetchOne();
```
- ê°™ì€ `QType`ì˜ ì¸ìŠ¤í„´ìŠ¤ë¼ê³  í•˜ë”ë¼ë„ ë‘ê°€ì§€ë¥¼ ì„ì–´ì„œ ì‚¬ìš©í•˜ë©´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŒ
```java
QItem qItem = new QItem("item");
QItem qItem2 = new QItem("item2");
Item found = queryFactory
          // SELECT item FROM Item item
          .selectFrom(qItem)
          // WHERE item2.name = "itemD" -> ?????
          .where(qItem2.name.eq("itemD"))
          .fetchOne();
```
- ì‹¤ì œë¡œ ì‚¬ìš©í•´ì•¼ í•˜ëŠ” ê²½ìš°ëŠ” ìê¸°ìì‹ ì„ ëŒ€ìƒìœ¼ë¡œ ì—°ê´€ê´€ê³„ê°€ ìˆì„ ë•Œ, ë‘ ì—”í‹°í‹°ë¥¼ êµ¬ë¶„í•´ì„œ ë‚˜íƒ€ë‚´ê¸° ìœ„í•¨
---
`QType`ë‚´ë¶€ì—ëŠ” `public static final`ë¡œ ì •ì˜ëœ `QType` ì¸ìŠ¤í„´ìŠ¤ê°€ í•˜ë‚˜ ë§Œë“¤ì–´ì ¸ ìˆìŒ
```java
@Generated("com.querydsl.codegen.DefaultEntitySerializer")
public class QItem extends EntityPathBase<Item> {
    // ...
    public static final QItem item = new QItem("item");
    // ...
}
```
- ì´ëŠ” `import static`ì„ ì´ìš©í•´ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŒ
- ìê¸° ìì‹ ê³¼ì˜ ì—°ê´€ê´€ê³„ê°€ í•„ìš”ì—†ëŠ” ìƒí™©ì´ë¼ë©´ ì´ ì¸ìŠ¤í„´ìŠ¤ë¥¼ í™œìš©í•˜ëŠ”ê²Œ ì½”ë“œë¥¼ ë” ê¹”ë”í•˜ê²Œ ì‘ì„± ê°€ëŠ¥
```java
import static com.example.querydsl.entity.QItem.item;

// ...

    public void test() {
    // static importë¥¼ í•˜ë©´ í´ë˜ìŠ¤ëª…ì„ ê±´ë„ˆë›¸ ìˆ˜ ìˆë‹¤.
    Item found = queryFactory
            .selectFrom(item)
            .where(item.name.eq("itemB"))
            .fetchOne();
    }
// ...
```