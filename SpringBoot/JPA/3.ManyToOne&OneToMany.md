## JPA
### ManyToOne & OneToMany
### Entity ê´€ê³„ ì„¤ì •
![RDB](RDB_relationship.png)

ì™¼ìª½ í…Œì´ë¸”ì˜ ì œì¡°ì‚¬ IDëŠ” ì˜¤ë¥´ìª½ í…Œì´ë¸”ì˜ IDë¥¼ ì˜ë¯¸
- ìì‹ ì˜ í…Œì´ë¸”ì´ ì•„ë‹Œ í…Œì´ë¸”ì˜ Key
- ì™¸ë¶€ì˜ í‚¤,ì™¸ë˜í‚¤(Foreign Key)

### RDBì—ì„œì˜ ê´€ê³„
> ğŸ’¡ RDB : Relational Database / ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤
1. 1:1 - One to One Relationship
- í•œ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ í•˜ë‚˜ê°€ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ í•˜ë‚˜ì™€ ì—°ê´€ëœ ê´€ê³„
- íŠ¹ì • ë°ì´í„°ë¥¼ ì„±ëŠ¥ ë˜ëŠ” ë³´ì•ˆì  ì¸¡ë©´ì—ì„œ ë‚˜ëˆŒ ë•Œ ì‚¬ìš©
- ë³´í†µì€ Foreign Key ì»¬ëŸ¼ì— Unique ì œì•½ ì‚¬í•­ì„ ì ìš©í•¨ìœ¼ë¡œì„œ êµ¬í˜„

2. N:1 - Many to One
- í•œ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ 0ê°œ ì´ìƒì´ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ í•˜ë‚˜ì™€ ì—°ê´€ëœ ê´€ê³„
- ì¼ë°˜ì ì¸ ë°ì´í„°ë² ì´ìŠ¤ì˜ ê°€ì¥ í”í•œ ê´€ê³„ ( ê²Œì‹œê¸€ - ëŒ“ê¸€ , ê°€ê²Œ - ìƒí’ˆ )
- í•˜ë‚˜ì˜ ë ˆì½”ë“œ ìª½ í…Œì´ë¸”ì˜ ì…ì¥ì—ì„œ í‘œí˜„í•  ê²½ìš° One to Manyë¡œ í‘œí˜„

3. M:N - Many to Many
- í•œ í…Œì´ë¸”ì˜ ë ˆì½”ë“œ 0ê°œ ì´ìƒì´ ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ê²Œì½”ë“œ 0ê°œ ì´ìƒê³¼ ì—°ê´€ëœ ê´€ê³„
- ì–‘ìª½ í…Œì´ë¸”ì˜ PKë¥¼ Foreign Keyë¡œ ê°€ì§„ ì œ 3ì˜ í…Œì´ë¸” ìƒì„±
- Join Table, Associative Tableë¼ê³  ë¶€ë¦„
---
### ORM -JPA
í•˜ë‚˜ì˜ í…Œì´ë¸”ì—ëŠ” ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ë ˆì½”ë“œë¥¼ ë„£ì§€ ëª»í•¨
- ê·¸ë˜ì„œ í…Œì´ë¸” ë°ì´í„°ë¥¼ í‘œí˜„í•˜ê¸° ìœ„í•´ ORM ë“±ì¥
- ORMì„ ì‚¬ìš©í•˜ë©´ í…Œì´ë¸”ê°„ ê´€ê³„ë¥¼ Entityì˜ í•„ë“œë¡œ í‘œí˜„ ê°€ëŠ¥
```java
@Entity
public class Article {
    private String title;
    @Lob
    private String content;

    // ì•„ë˜ Userì™€ CommentëŠ” ë‹¤ë¥¸ Entity í´ë˜ìŠ¤ ì…ë‹ˆë‹¤.
    private User writer;
    private List<Comment> comments;
}
```
----
### Student - Lecture - Intstructor ERD
![student-ERD](student_ERD.png)
- `student` í…Œì´ë¸”ê³¼ `instructor` í…Œì´ë¸”ì´ N : 1 ê´€ê³„
### `@ManyToOne`
```java
// Student Entity
@Data
@Entity
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private Integer age;
    private String phone;
    private String email;
}
```
```java
// Instructor Entity
@Entity
public class Instructor {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String firstName;
    private String lastName;

}
```
- ì‹¤ì œ í…Œì´ë¸”ì—ëŠ” `student` í…Œì´ë¸”ì— `advisor_id`ê°€ í¬í•¨ë  ì˜ˆì •
- ì—¬ëŸ¬ `Student` Entityê°€ `Instructor` Entityì™€ ì—°ê´€ ë  ìˆ˜ ìˆê¸° ë•Œë¬¸
- `Student` Entityì— `Instructor` Entityë¥¼ í¬í•¨ ì‹œí‚¤ê³  `@ManytoOne` ì¶”ê°€
- ì»¬ëŸ¼ ì´ë¦„ì„ ë°”ê¾¸ê³  ì‹¶ì„ ë–„ëŠ” `@JoinColumn` ì— name ì†ì„± ì¶”ê°€
```java
// Student Entity
@Data
@Entity
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private Integer age;
    private String phone;
    private String email;
    
    @ManyToOne
    @JoinColumn(name = "advisor")
    private Instructor advisor;
}
```
- ìƒˆë¡œìš´ `Studnet` Entityë¥¼ ë“±ë¡í•  ë–„ `Instructor` Entityë¥¼ ì°¾ì•„ì„œ ë°°ì •
```java
@GetMapping("create-view")
public String createView(Model model) {
    model.addAttribute("instructors", instructorRepository.findAll());
    return "student/create";
}
```
- `StudentController.createView` ë©”ì„œë“œëŠ” ì „ì²´ `Instructor` ë°ì´í„°ë¥¼ Modelì— ì „ë‹¬í•¨ìœ¼ë¡œì„œ ì‚¬ìš©ìê°€ ì„ íƒí•  ìˆ˜ ìˆëŠ” `Instructor`ëª©ë¡ì„ `create.html`ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ì „ë‹¬
- `create.html`
```java
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org/">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
  <style>
    .mb-3 {
        margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <h1>Create Student</h1>
  <form action="/student/create" method="post">
    <div class="mb-3">
      <label>
        Name: <input type="text" name="name" value="Lorem Ipsum">
      </label>
    </div>
    <div class="mb-3">
      <label>
        Age: <input type="number" name="age" value="25">
      </label>
    </div>
    <div class="mb-3">
      <label>
        Phone: <input type="text" name="phone" value="010-0000-0000">
      </label>
    </div>
    <div class="mb-3">
      <label>
        Email: <input type="text" name="email" value="lorem@gmail.com">
      </label>
    </div>
    <div class="mb-3">
      <label>
        Instructor:
        <select name="advisor-id">
          <option
                  th:each="instructor: ${instructors}"
                  th:value="${instructor.id}"
          >
            [[${instructor.firstName}]] [[${instructor.lastName}]]
          </option>
        </select>
      </label>
    </div>
    <div class="mb-3">
      <input type="submit">
    </div>
  </form>
</body>
</html>
```
- `create.html`ì˜ `select`ìš”ì†ŒëŠ” ì „ë‹¬ë°›ì€ `Instructor` ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë³µìˆ˜ì˜ `option` ìš”ì†Œë¥¼ ìƒì„±
- ë‚˜ì¤‘ì— ì„œë²„ë¡œ ì „ì†¡ë  ë•Œ `advisor-id`ì˜ ì´ë¦„ìœ¼ë¡œ ì „ì†¡ë˜ë©°
- ì´ë¥¼ `@RequestParam`ìœ¼ë¡œ ë°›ì„ ìˆ˜ë„ ìˆìŒ
- ì „ë‹¬ë°›ì€ `advisor-id`ì˜ ê°’ì„ ë°”íƒ•ìœ¼ë¡œ `Instructor` ê°ì²´ë¥¼ ì°¾ì•„ë‚¸ë‹¤ë©´ í•´ë‹¹ ê°’ì„ `student`ì— í• ë‹¹í•˜ì—¬ ê´€ê³„ ì„¤ì • ê°€ëŠ¥
```java
// Controller.java
@PostMapping("create")
public String create(
        @RequestParam("name")
        String name,
        @RequestParam("age")
        Integer age,
        @RequestParam("phone")
        String phone,
        @RequestParam("email")
        String email,
        @RequestParam("advisor-id")
        Long advisorId
                ) {
                Student student = new Student();
                student.setName(name);
                student.setAge(age);
                student.setPhone(phone);
                student.setEmail(email);
                student.setAdvisor(
                        instructorRepository.findById(advisorId).orElse(null));
                studentRepository.save(student);
                return "redirect:/student/create-view";
                }
```
- ë§Œì•½ ì´ `Student` Entityì˜ `Instructor` ì •ë³´ë¥¼ í™œìš©í•˜ê³  ì‹¶ë‹¤ë©´ `.getInstructor()` í™œìš©
- `.getInstructor()`ì€ `Instructor` Entityê°€ ë“±ì¥
- `student.setAdvisor(instructorRepository.findById(advisorId).orElse(null));` : `Instructor` Entity ì°¾ì•„ì„œ í• ë‹¹ í›„ `save()`
---
### `@OneToMany`
- `Instructor`ì˜ `Student` ì •ë³´ê°€ ì•Œê³  ì‹¶ì„ ë•Œ
- `Instructor`ì˜ PKë¥¼ ê¸°ì¤€ìœ¼ë¡œ `Student`í…Œì´ë¸”ì˜ FKë¥¼ ê²€ìƒ‰
- ë¹„ìŠ·í•˜ê²Œ `JpaRepository`ì— Query Method ì¶”ê°€ë„ ê°€ëŠ¥
```java
public interface StudentRepository extends JpaRepository<Student, Long> {
    List<Student> findAllByAdvisor(Instructor entity);
    List<Student> findAllByAdvisorId(Long id);
}
```
- `@OneToMany` ì¶”ê°€
```java
@Entity
public class Instructor {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String firstName;
    private String lastName;

    @OneToMany(mappedBy = "advisor")
    private List<Student> advisingStudents;
}
```
- ì´ë–„ `mappedBy` ëŠ” ë°˜ëŒ€ìª½ `@ManyToOne` ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ í•„ë“œì˜ ì´ë¦„ ì‘ì„±
- ë°˜ëŒ€ìª½(ê´€ê³„ì˜ ì£¼ê°€ ë˜ëŠ”) Entityì˜ ì–´ë–¤ ì†ì„±ì„ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ”ì§€ ì •ì˜í•˜ê¸° ìœ„í•¨
```java
@GetMapping("{id}")
public String readOne(
        @PathVariable("id")
        Long id,
        Model model
) {
    Instructor instructor = instructorRepository.findById(id).orElse(null);
    model.addAttribute("instructor", instructor);
    model.addAttribute("advisingStudents", instructor.getAdvisingStudents());
    return "instructor/read";
}
```