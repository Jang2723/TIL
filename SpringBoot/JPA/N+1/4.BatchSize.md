## `@BatchSize`
### Paginationì„ ì ìš©í•´ë³´ì
- Fetch Join ë˜ëŠ” `@EntityGraph` ë‘˜ë‹¤ N + 1ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ”ë° ì •ë‹¹í•œ ë°©ë²•ì´ì§€ë§Œ 
- `@OneToMany`ë¥¼ ì²˜ë¦¬í•˜ë©´ì„œ JPAì˜ í˜ì´ì§€ ê¸°ëŠ¥ì„ í™œìš©í•  ë•Œ ë¬¸ì œê°€ ë°œìƒ
- `@OneToMany`ë¥¼ Fetch Join í•˜ë©´ì„œ `Pageable`ì„ ë§¤ê°œë²¼ìˆ˜ë¡œ ì„¤ì •í•˜ë©´?
```java
@Query("SELECT DISTINCT i FROM Instructor i LEFT JOIN FETCH i.advisingStudents")
Page<Instructor> findByFetchPage(Pageable pageable);
```
```text
ë¡œê·¸> HHH90003004: firstResult/maxResults specified with collection fetch; applying in memory
Hibernate: 
    select
        distinct i1_0.id,
        as1_0.advisor_id,
        as1_0.id,
        as1_0.age,
        as1_0.email,
        as1_0.name,
        as1_0.phone,
        i1_0.name 
    from
        instructor i1_0 
    left join
        student as1_0 
            on i1_0.id=as1_0.advisor_id
Hibernate: 
    select
        count(distinct i1_0.id) 
    from
        instructor i1_0 
    left join
        student as1_0 
            on i1_0.id=as1_0.advisor_id
```
- ìˆ˜ìƒí•œ ë¡œê·¸ì™€ í•¨ê»˜, `limit`ë‚˜ `offset`ì´ ì—†ëŠ” ì¿¼ë¦¬ê°€ ë°œìƒ
- ì´ëŠ” `limit`ê³¼ `offset`ì´ ê²°êµ­ ê²°ê³¼ ì—´ì˜ ê°¯ìˆ˜ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ê²ƒì¸ë°
- `@OneToMany`ê´€ê³„ë¥¼ í…Œì´ë¸”ë¡œ í‘œí˜„í•˜ë©´ í•˜ë‚˜ì˜ ì—”í‹°í‹°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—´ì´ ë³µìˆ˜ê°œê°€ ë°œìƒí•˜ê²Œ ë˜ë©°, 
- í•œ í˜ì´ì§€ì˜ í•œ ê°œì²´ì— í•´ë‹¹í•˜ëŠ” ì—”í‹°í‹°ê°€ ëª‡ê°œì˜ ì—´ì— ê±¸ì³ì„œ ë§Œë“¤ì–´ì§€ëŠ”ì§€ë¥¼ ì‚¬ì „ì— ì•Œ ìˆ˜ ì—†ê¸° ë•Œë¬¸
```sql
select i.id, i.name
from instructor i inner join student s
    on i.id = s.advisor_id
order by i.id;
```
![pagination](10.batchSize1.png)
- ì‹¤í–‰í•œ ê²°ê³¼, ì „ì²´ ë°ì´í„°ë¥¼ ì¿¼ë¦¬ë¡œ ë¨¼ì € ë¶ˆëŸ¬ì˜¨ ë‹¤ìŒ, ì—°ê´€ ê´€ê³„ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì²˜ë¦¬í•˜ëŠ”ê²Œ ì•„ë‹Œ JPAì—ì„œ ì²˜ë¦¬ë¥¼ í•œë‹¤ëŠ” ì˜ë¯¸
- í˜ì´ì§• ì²˜ë¦¬ë¥¼ í•œ ì´ìœ ê°€ ì‚¬ë¦¬ì¦Œ ê²ƒê³¼ ë§ˆì°¬ê°€ì§€!

### `@BatchSize`
- ì´ëŸ° `@OneToMany` ê´€ê³„ì—ì„œëŠ” ì—°ê´€ ê´€ê³„ ë°ì´í„°ë¥¼ í•œë²ˆì— ê°€ì ¸ì˜¤ë©´ì„œ í˜ì´ì§€ë„ ìœ ì—°í•˜ê²Œ ì²˜ë¦¬í•˜ê¸°ëŠ” ì–´ë ¤ì›€
- ëŒ€ì‹ , ì§€ì—°ë¡œë”©ìœ¼ë¡œ ì„¤ì •ëœ `@OneToMany`ì˜ ê²½ìš°, í•´ë‹¹í•˜ëŠ” `@OneToMany`ì†ì„±ì„ ìš”ì²­í•˜ëŠ” ì‹œì ì—, ì—¬ëŸ¬ Entityë¥¼ ëŒ€ìƒìœ¼ë¡œ í•˜ëŠ” ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ê°€ëŠ¥
- `Instructor`ì˜ `@OneToMany`ì— ëŒ€í•œ ì†ì„±ì— `@BatchSize`ë¥¼ ì£¼ê³  `size = 5`ë¡œ ì„¤ì •
```java
@BatchSize(size = 5)
@OneToMany(mappedBy = "advisor", fetch = FetchType.LAZY)
private final List<Student> advisingStudents = new ArrayList<>();
```
- í˜ì´ì§• ê¸°ëŠ¥ì„ ìœ„í•´ ë³´í†µì˜ `findAll(Pageable pageable)` ì‚¬ìš©
```java
instructorRepository.findAll(PageRequest.of(0, 10))
        .forEach(i -> System.out.println(i.getAdvisingStudents().size()));
```
- ì´ 4ë²ˆì˜ ì¿¼ë¦¬ ë°œìƒ
1. `LIMIT`,`OFFSE`ì„ í¬í•¨í•œ ì¡°íšŒ ì¿¼ë¦¬
2. ì „ì²´ í˜ì´ì§€ ì •ë³´ í™•ì¸ì„ ìœ„í•œ `COUNT` ì¿¼ë¦¬
![BATCHSIZE2](11.BATCHSIZE2.png)
- ì´í›„ ë‚˜ì˜¤ëŠ” ì²«ë²ˆì§¸ ì¿¼ë¦¬ëŠ”,`Student`ë¥¼ ì¡°íšŒí•˜ë©´ì„œ FK ì»¬ëŸ¼ì¸ `advisor_id`ê°€ íŠ¹ì • `id`ë“¤ ì¤‘ í•˜ë‚˜ì¸ `Student`ë¥¼ ì¡°íšŒí•˜ëŠ” ì¿¼ë¦¬
![batchsize3](12.batchsize3.png)
- ì´ëŸ° ì¿¼ë¦¬ê°€ ì´ 2ë²ˆ ë°œìƒ
- ì´ ë‘ ì¿¼ë¦¬ëŠ” `@BatchSize`ë¡œ ì¸í•´ ë§Œë“¤ì–´ì§€ëŠ” ì¿¼ë¦¬
- ë³¸ë˜ í•˜ë‚˜ì˜ `Instructor`ì˜ `@OneToMany`ë¥¼ ì¡°íšŒí•  ë•Œ í•œë²ˆì˜ `SELECT`ë¥¼ í˜¸ì¶œí•˜ëŠ” ëŒ€ì‹ , 
- í•œë²ˆ í˜¸ì¶œí•  ë•Œ `@BatchSize`ë¡œ ì •í•´ì§„ ìˆ˜ëŸ‰ë§Œí¼ì˜ `Instructor`ë¥¼ ê¸°ì¤€ìœ¼ë¡œ `Student`ë¥¼ ê²€ìƒ‰í•˜ëŠ” ì¿¼ë¦¬
- ì¦‰, ì§€ì—°ë¡œë”©ì„ ìœ ì§€í•˜ë©´ì„œ, ëŒ€ì‹  ì‹¤ì œ ë¡œë”©ì´ í•„ìš”í•œ ì‹œì ì— ì •í•´ì§„ ìˆ˜ëŸ‰ë§Œí‚ í•œë²ˆì— ë¡œë”©í•¨ìœ¼ë¡œì„œ N+1 ë³´ë‹¤ëŠ” ì¿¼ë¦¬ë¥¼ ëœ ë‚ ë¦¬ëŠ” ë°”ì‹ì˜ í•´ê²°ë²•


> ğŸ’¡ 2ë²ˆì˜ ì¿¼ë¦¬ 
> 1. `@OneToMany`ë¥¼ ì¡°íšŒí•  ë•Œ `@BatchSize`ë§Œí¼ `Student`ë“¤ì„ ì¡°íšŒ   
> 2. `@BatchSize`ë¥¼ ë„˜ì–´ê°„ `@OneToMany`ë¥¼ ì¡°íšŒí•  ë•Œ ë‹¤ìŒ `Student`ë“¤ì„ ì¡°íšŒ