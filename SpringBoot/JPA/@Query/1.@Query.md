## `@Query`
### `@Query`ì™€ JPQL
- Spring Data JPAì˜ Query MethodsëŠ” ê°„ë‹¨í•˜ë©´ì„œë„ ê°•ë ¥í•œ ê¸°ëŠ¥
  - íŠ¹ë³„í•œ ì½”ë“œ ì—†ì´ ë©”ì„œë“œì˜ ì´ë¦„ì„ ë°”íƒ•ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ” ë°ì´í„°ì˜ ì¡°ê±´ ì§€ì • ê°€ëŠ¥
  - ë‹¨ì 
    - ê°„ë‹¨í•œ ì¡°ê±´ì„ ì œì‹œí•˜ëŠ”ë°ë„ ë©”ì„œë“œì˜ ì´ë¦„ì´ ì¥í™©í•´ì§
    - ì¡°ê¸ˆ ë³µì¡í•œ ì¡°ê±´, ì§‘ê³„ í•¨ìˆ˜ ë“±ì„ í™œìš©í•˜ê¸° ì–´ë ¤ì›€


- Query Method ì˜ˆì‹œ
```java
public interface ArticleRepository extends JpaRepository<Article, Long> {
    // ì£¼ì–´ì§„ idë³´ë‹¤ idê°€ í° ê°€ì¥ ì²« ê²Œì‹œê¸€
    Optional<Article> findFirstByIdAfter(Long id);
    // ì£¼ì–´ì§„ idë³´ë‹¤ idê°€ ê°€ì¥ ì‘ì€ ê²Œì‹œê¸€ì„ ì—­ìˆœ ì •ë ¬í–ˆì„ ë•Œ ì²« ê²Œì‹œê¸€
    Optional<Article> findFirstByIdBeforeOrderByIdDesc(Long id);

    // ì£¼ì–´ì§„ boardIdì™€ ì¼ì¹˜í•˜ë©° ì£¼ì–´ì§„ idë³´ë‹¤ idê°€ í° ê°€ì¥ ì²« ê²Œì‹œê¸€
    Optional<Article> findFirstByBoardIdAndIdAfter(Long boardId, Long id);
    // ì£¼ì–´ì§„ boardIdì™€ ì¼ì¹˜í•˜ë©° ì£¼ì–´ì§„ idë³´ë‹¤ idê°€ ê°€ì¥ ì‘ì€ ê²Œì‹œê¸€ì„ ì—­ìˆœ ì •ë ¬í–ˆì„ ë•Œ ì²« ê²Œì‹œê¸€
    Optional<Article> findFirstByBoardIdAndIdBeforeOrderByIdDesc(Long boardId, Long id);
}
```
---
### Student-Lecture-Instructor Entity / ERD
![ERD](student-lectur_ERD.png)
```java
@Entity
public class Instructor {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;

    @OneToMany(mappedBy = "advisor")
    private final List<Student> advisingStudents = new ArrayList<>();
}
```
```java
@Entity
public class Lecture {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private String day;
    private Integer startTime;
    private Integer endTime;

    @ManyToOne
    private Instructor instructor;

    @ManyToMany(mappedBy = "attending")
    private final List<Student> students = new ArrayList<>();
}
```
```java
@Entity
public class Student {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private String name;
    private Integer age;
    private String phone;
    private String email;

    @ManyToOne
    @JoinColumn(name = "advisor_id")
    private Instructor advisor;

    @ManyToMany
    @JoinTable(
            name = "attending_lectures",
            joinColumns = @JoinColumn(name = "student_id"),
            inverseJoinColumns = @JoinColumn(name = "lecture_id")
    )
    private final List<Lecture> attending = new ArrayList<>();
}
```
---
### `@Query`
- `JpaRepository`ë¥¼ ë¹„ë¡¯í•œ `Repository` ì¸í„°í˜ì´ìŠ¤ ë©”ì„œë“œì— ë¶™ì—¬ì„œ SQLì„ ì‘ì„±í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì–´ë…¸í…Œì´ì…˜
- **JPQL(Java Persistence Query Language)** ì–¸ì–´ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‚¬ìš©

```text
ğŸ’¡ JPQL 
- Java Persistence API(JPA)ëŠ” ê°ì²´ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥í•˜ê³  ê´€ë¦¬í•˜ëŠ” ìë°”ì˜ í‘œì¤€ ê¸°ìˆ 
- JPQLì€ JPAì—ì„œ ì‚¬ìš©ë˜ëŠ” ê°ì²´ì§€í–¥ ì¿¼ë¦¬ ì–¸ì–´ë¡œ ì—”í‹°í‹°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ì— ì¿¼ë¦¬ë¥¼ ë³´ë‚´ê¸° ìœ„í•´ ì‚¬ìš©
- SQLê³¼ ìœ ì‚¬í•˜ì§€ë§Œ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ê³¼ ì»¬ëŸ¼ ëŒ€ì‹  ì—”í‹°í‹°ì™€ ì†ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ì–¸ì–´
    - => SQLì²˜ëŸ¼ ì‘ì„±í•˜ê³ , ê²°ê³¼ë¥¼ ë‹¤ì‹œ Entity í´ë˜ìŠ¤ë¡œ ë°›ê¸° ê°€ëŠ¥
    - ê°œë°œìê°€ ì§ê´€ì ìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŒ
- JPQLì€ Entity Managerë¥¼ í†µí•´ ì‹¤í–‰, ê²°ê³¼ëŠ” ì—”í‹°í‹° ê°ì²´ ë˜ëŠ” ì—”í‹°í‹° ì»¬ë ‰ì…˜ìœ¼ë¡œ ë°˜í™˜
- íŠ¹ì • ë°ì´í„°ë² ì´ìŠ¤ì— ì¢…ì†ë˜ì§€ ì•Šìœ¼ë©°, JPAê°€ ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ ë²¤ë”ì™€ í˜¸í™˜ë˜ë„ë¡ ì„¤ê³„ë˜ì–´ ìˆì–´ ì—¬ëŸ¬ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ë™ì¼í•œ ì¿¼ë¦¬ ì‹¤í–‰ ê°€ëŠ¥
``` 


- `LectureRepository`ì— `@Query`ë¥¼ ì¶”ê°€í•˜ì—¬, 12ì‹œ ì´ì „ì— ì‹œì‘í•˜ëŠ” `lecture` ë°˜í™˜í•˜ëŠ” JPQL
```java
@Query("SELECT l FROM Lecture l WHERE l.startTime < 12")
List<Lecture> findLecturesBeforeLunch();
```
- `lecture` í…Œì´ë¸”ì„ ì§€ì •í•˜ëŠ” ëŒ€ì‹  ì¡°íšŒí•  Entity `Lecture`ë¥¼ ì§€ì •í•˜ê³ 
- `l` ì´ë¼ëŠ” aliasë¥¼ ë¶€ì—¬í•˜ê³ , ë³€ìˆ˜ì²˜ëŸ¼ ê°€ì§€ê³  ìˆëŠ” `startTime`ì†ì„± ì‚¬ìš©
- SQL ì‚¬ìš©í•˜ê³  ì‹¶ì„ ê²½ìš° `nativeQuery`ì˜µì…˜ì„ `true`ë¡œ ì„¤ì •
```java
@Query(
        value = "SELECT * FROM lecture WHERE start_time < 12",
        nativeQuery = true
)
List<Lecture> findLecturesBeforeLunchNative();
```
- ë‹¨, SQLì„ ì‚¬ìš©í•´ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ê²½ìš° ì¡°íšŒëœ ë°ì´í„°ì˜ ì»¬ëŸ¼ê³¼ Entityê°€ ì¼ì¹˜í•´ì•¼ ìœ ì—°í•˜ê²Œ ì‹¤ì œ Entityë¡œ ë°˜í™˜
- ì¼ë¶€ë§Œ ì¡°íšŒì‹œ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ì§€ ì•Šì€ ê°€ëŠ¥ì„± ì¡´ì¬
> âš ï¸ JPQLì„ `@Query`ì— ë„£ê¸°ë§Œ í•˜ë©´ ë©”ì„œë‹¥ ì„ ì–¸ëœ, JpaRepository<T,ID>ì˜ `T`(Entity)ì™€ ìƒê´€ì—†ì´, ì•„ë¬´ Entityí´ë˜ìŠ¤ë“  ì‚¬ìš© ê°€ëŠ¥ 
> ì—°ê´€ì„±ìˆëŠ” `Repository`ì—ì„œ ì‘ì„±í•˜ëŠ” ê²ƒì„ ê¶Œì¥

- `Pageable`ê³¼ `Sort`ê°€ëŠ¥
```java
@Query("SELECT l FROM Lecture l WHERE l.startTime < 12")
List<Lecture> findLecturesBeforeLunch(Sort sort);

@Query("SELECT l FROM Lecture l WHERE l.startTime < 12")
List<Lecture> findLecturesBeforeLunch(Pageable pageable);
```
- `nativeQuery`ë¥¼ ì‚¬ìš©í•  ê²½ìš° `Sort` êµ¬í˜„ ë¶ˆê°€ëŠ¥
- `Pageable`ì˜ ê²½ìš° `countQuery`ë¥¼ ì´ìš©í•´ ì´ ê°¯ìˆ˜ë¥¼ ë°˜í™˜í•˜ëŠ” SQLì„ ì‘ì„±í•¨ìœ¼ë¡œì„œ êµ¬í˜„ ê°€ëŠ¥
```java
@Query(
        value = "SELECT * FROM lecture WHERE start_time < 12",
        countQuery = "SELECT count(*) FROM lecture WHERE start_time < 12",
        nativeQuery = true
)
List<Lecture> findLecturesBeforeLunchNative(Pageable pageable);
```